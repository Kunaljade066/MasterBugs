<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hitwicket- BugTracker</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#09090e;--surface:#0f0f17;--surface2:#141420;--surface3:#1a1a28;
  --border:#1e1e30;--border2:#252540;
  --accent:#7c3aed;--accent-light:rgba(124,58,237,0.12);
  --cyan:#06b6d4;--green:#10b981;--warn:#f59e0b;--danger:#ef4444;
  --text:#e2e2f0;--text2:#9090b0;--text3:#4a4a6a;
  --critical:#ff3b6b;--high:#f97316;--medium:#eab308;--low:#22c55e;
  --open:#6366f1;--inprog:#06b6d4;--review:#f59e0b;--done:#10b981;--closed:#6b7280;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(124,58,237,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(124,58,237,0.025) 1px,transparent 1px);background-size:36px 36px;pointer-events:none;z-index:0}

/* LOCK */
#lockScreen{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column}
#lockScreen::before{content:'';position:absolute;inset:0;background-image:linear-gradient(rgba(124,58,237,0.05) 1px,transparent 1px),linear-gradient(90deg,rgba(124,58,237,0.05) 1px,transparent 1px);background-size:36px 36px;pointer-events:none}
.lock-box{position:relative;background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:48px 40px 40px;width:100%;max-width:420px;text-align:center;box-shadow:0 0 80px rgba(124,58,237,0.12)}
.lock-icon-wrap{width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--cyan));display:inline-flex;align-items:center;justify-content:center;font-size:26px;margin-bottom:20px;box-shadow:0 8px 24px rgba(124,58,237,0.3)}
.lock-title{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:26px;color:var(--text);margin-bottom:4px;letter-spacing:-0.5px}
.lock-sub{font-size:11px;letter-spacing:3px;color:var(--text3);text-transform:uppercase;margin-bottom:28px}
.lock-input-wrap{display:flex;gap:8px;margin-bottom:10px}
.lock-input-wrap input{flex:1;background:var(--bg);border:1px solid var(--border2);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:14px;padding:13px 14px;border-radius:6px;outline:none;letter-spacing:3px;transition:border-color 0.2s}
.lock-input-wrap input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,0.15)}
.lock-input-wrap input::placeholder{letter-spacing:1px;color:var(--text3);font-size:12px}
.lock-btn{background:var(--accent);color:white;border:none;padding:13px 20px;font-family:'DM Sans',sans-serif;font-weight:700;font-size:13px;letter-spacing:1px;cursor:pointer;border-radius:6px;transition:all 0.2s;white-space:nowrap}
.lock-btn:hover{background:#6d28d9;transform:translateY(-1px);box-shadow:0 4px 16px rgba(124,58,237,0.4)}
.lock-error{font-size:12px;color:var(--danger);min-height:18px;margin-top:6px;font-family:'JetBrains Mono',monospace}
.lock-attempts{font-size:11px;color:var(--text3);margin-top:12px;letter-spacing:1px}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
.lock-shake{animation:shake 0.4s ease}

/* APP */
#app{position:relative;z-index:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:56px;border-bottom:1px solid var(--border);background:rgba(9,9,14,0.95);backdrop-filter:blur(12px);position:sticky;top:0;z-index:100}
.topbar-left{display:flex;align-items:center;gap:12px}
.app-logo{width:30px;height:30px;border-radius:7px;background:linear-gradient(135deg,var(--accent),var(--cyan));display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:white;font-family:'JetBrains Mono',monospace;flex-shrink:0}
.app-name{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:15px;color:var(--text);letter-spacing:-0.3px}
.app-name span{color:var(--accent)}
.topbar-right{display:flex;align-items:center;gap:10px}
.conn-badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace;letter-spacing:1px}
.conn-badge.ok{background:rgba(16,185,129,0.12);color:var(--green);border:1px solid rgba(16,185,129,0.2)}
.conn-badge.err{background:rgba(239,68,68,0.12);color:var(--danger);border:1px solid rgba(239,68,68,0.2)}
.conn-badge.load{background:rgba(99,102,241,0.12);color:#818cf8;border:1px solid rgba(99,102,241,0.2)}
.btn-icon{width:34px;height:34px;border-radius:7px;border:1px solid var(--border2);background:var(--surface2);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all 0.15s}
.btn-icon:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}

/* LAYOUT */
.layout{display:flex;flex:1}
.sidebar{width:220px;flex-shrink:0;border-right:1px solid var(--border);background:var(--surface);padding:16px 0;position:sticky;top:56px;height:calc(100vh - 56px);overflow-y:auto}
.sidebar-section{margin-bottom:24px}
.sidebar-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);padding:0 16px;margin-bottom:8px;font-weight:600}
.sidebar-item{display:flex;align-items:center;gap:10px;padding:8px 16px;cursor:pointer;transition:all 0.12s;border-left:2px solid transparent;font-size:13px;color:var(--text2);font-weight:500}
.sidebar-item:hover{background:var(--surface2);color:var(--text)}
.sidebar-item.active{background:var(--accent-light);color:var(--accent);border-left-color:var(--accent)}
.sidebar-item .si-icon{font-size:14px;width:18px;text-align:center}
.sidebar-badge{margin-left:auto;background:var(--accent);color:white;font-size:10px;padding:1px 6px;border-radius:10px;font-weight:700;font-family:'JetBrains Mono',monospace}
.sidebar-badge.red{background:var(--danger)}
.main{flex:1;padding:24px;overflow-y:auto;min-width:0}

/* PAGE */
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.page-title{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:var(--text)}
.page-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

/* BUTTONS */
.btn{padding:8px 16px;border-radius:6px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600;font-size:13px;transition:all 0.15s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:white}
.btn-primary:hover{background:#6d28d9;transform:translateY(-1px);box-shadow:0 4px 12px rgba(124,58,237,0.3)}
.btn-secondary{background:var(--surface3);color:var(--text2);border:1px solid var(--border2)}
.btn-secondary:hover{color:var(--text);border-color:var(--accent)}
.btn-danger{background:rgba(239,68,68,0.12);color:var(--danger);border:1px solid rgba(239,68,68,0.2)}
.btn-danger:hover{background:rgba(239,68,68,0.2)}
.btn-sm{padding:5px 10px;font-size:12px}
.btn-ai{background:linear-gradient(135deg,var(--accent),var(--cyan));color:white;box-shadow:0 4px 16px rgba(124,58,237,0.25)}
.btn-ai:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(124,58,237,0.4)}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px}
.stat-card .sc-num{font-family:'JetBrains Mono',monospace;font-size:28px;font-weight:700}
.stat-card .sc-label{font-size:12px;color:var(--text2);margin-top:2px;font-weight:500}
.stat-card .sc-bar{height:3px;border-radius:2px;margin-top:10px}
.stat-open .sc-num{color:var(--open)}.stat-open .sc-bar{background:var(--open)}
.stat-prog .sc-num{color:var(--inprog)}.stat-prog .sc-bar{background:var(--inprog)}
.stat-crit .sc-num{color:var(--critical)}.stat-crit .sc-bar{background:var(--critical)}
.stat-done .sc-num{color:var(--done)}.stat-done .sc-bar{background:var(--done)}

/* FILTER */
.filter-bar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.filter-input{background:var(--surface);border:1px solid var(--border2);color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:8px 12px;border-radius:6px;outline:none;transition:border-color 0.2s;min-width:200px}
.filter-input:focus{border-color:var(--accent)}
.filter-select{background:var(--surface);border:1px solid var(--border2);color:var(--text2);font-family:'DM Sans',sans-serif;font-size:12px;padding:8px 10px;border-radius:6px;outline:none;cursor:pointer;transition:border-color 0.2s}
.filter-select:focus{border-color:var(--accent);color:var(--text)}

/* TABLE */
.bug-table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.bug-table-header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border);background:var(--surface2)}
.bug-table-header h3{font-size:14px;font-weight:600;color:var(--text)}
.table-scroll{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{padding:10px 14px;text-align:left;border-bottom:1px solid var(--border);color:var(--text3);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;white-space:nowrap;background:var(--surface2);cursor:pointer;user-select:none}
thead th:hover{color:var(--text2)}
tbody tr{border-bottom:1px solid var(--border);transition:background 0.1s;cursor:pointer}
tbody tr:hover{background:var(--surface2)}
tbody tr:last-child{border-bottom:none}
tbody td{padding:11px 14px;vertical-align:middle;color:var(--text);max-width:260px}
.td-id{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);white-space:nowrap}
.td-title{font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.td-actions{display:flex;gap:6px;white-space:nowrap}

/* CHIPS */
.chip{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:700;white-space:nowrap;font-family:'JetBrains Mono',monospace;letter-spacing:0.3px}
.chip-critical{background:rgba(255,59,107,0.12);color:var(--critical);border:1px solid rgba(255,59,107,0.25)}
.chip-high{background:rgba(249,115,22,0.12);color:var(--high);border:1px solid rgba(249,115,22,0.25)}
.chip-medium{background:rgba(234,179,8,0.12);color:var(--medium);border:1px solid rgba(234,179,8,0.25)}
.chip-low{background:rgba(34,197,94,0.12);color:var(--low);border:1px solid rgba(34,197,94,0.25)}
.chip-urgent{background:rgba(239,68,68,0.12);color:var(--danger);border:1px solid rgba(239,68,68,0.25)}
.chip-open{background:rgba(99,102,241,0.12);color:var(--open);border:1px solid rgba(99,102,241,0.25)}
.chip-inprogress{background:rgba(6,182,212,0.12);color:var(--inprog);border:1px solid rgba(6,182,212,0.25)}
.chip-review{background:rgba(245,158,11,0.12);color:var(--warn);border:1px solid rgba(245,158,11,0.25)}
.chip-done{background:rgba(16,185,129,0.12);color:var(--done);border:1px solid rgba(16,185,129,0.25)}
.chip-closed{background:rgba(107,114,128,0.12);color:#9ca3af;border:1px solid rgba(107,114,128,0.25)}
.chip-default{background:rgba(99,102,241,0.08);color:var(--text2);border:1px solid var(--border2)}
.avatar{width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:white;flex-shrink:0}

/* PAGER */
.pager{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;border-top:1px solid var(--border);background:var(--surface2)}
.pager-btns{display:flex;gap:4px}
.pager-btn{background:var(--surface3);border:1px solid var(--border2);color:var(--text2);padding:5px 10px;border-radius:5px;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.15s}
.pager-btn:hover{border-color:var(--accent);color:var(--accent)}
.pager-info{font-size:12px;color:var(--text3);font-family:'JetBrains Mono',monospace}

/* SLIDE PANEL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:800;display:none;backdrop-filter:blur(2px)}
.overlay.open{display:block}
.slide-panel{position:fixed;right:0;top:0;height:100%;width:600px;max-width:100vw;background:var(--surface);border-left:1px solid var(--border2);z-index:900;transform:translateX(100%);transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);display:flex;flex-direction:column;overflow:hidden}
.slide-panel.open{transform:translateX(0)}
.sp-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface2);flex-shrink:0}
.sp-title{font-weight:700;font-size:16px;color:var(--text)}
.sp-body{flex:1;overflow-y:auto;padding:24px}
.sp-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;background:var(--surface2);flex-shrink:0}

/* FORM */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.form-group{display:flex;flex-direction:column;gap:6px}
.form-group.full{grid-column:1/-1}
.form-label{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px}
.form-input,.form-select,.form-textarea{background:var(--bg);border:1px solid var(--border2);color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 12px;border-radius:6px;outline:none;transition:border-color 0.2s;width:100%}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,0.1)}
.form-textarea{min-height:80px;resize:vertical;line-height:1.6}
.form-select option{background:var(--surface2)}

/* AI */
.ai-panel{background:var(--bg);border:1px solid var(--border2);border-radius:8px;padding:16px;margin-top:16px}
.ai-panel-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.ai-label{font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;background:linear-gradient(135deg,var(--accent),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.ai-result{font-size:13px;color:var(--text2);line-height:1.7;white-space:pre-wrap}
.ai-spinner{display:none;align-items:center;gap:8px;color:var(--text3);font-size:12px}
.ai-spinner.on{display:flex}
.spin-ring{width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin 0.7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* KANBAN */
.kanban{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;overflow-x:auto;padding-bottom:8px}
.kanban-col{background:var(--surface);border:1px solid var(--border);border-radius:8px;min-width:200px;display:flex;flex-direction:column}
.kanban-col-header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.kanban-col-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px}
.kanban-count{background:var(--surface3);color:var(--text2);font-size:11px;padding:1px 7px;border-radius:10px;font-weight:700;font-family:'JetBrains Mono',monospace}
.kanban-cards{flex:1;padding:10px;display:flex;flex-direction:column;gap:8px;min-height:60px}
.kanban-card{background:var(--surface2);border:1px solid var(--border2);border-radius:6px;padding:10px 12px;cursor:pointer;transition:all 0.15s}
.kanban-card:hover{border-color:var(--accent);transform:translateY(-1px);box-shadow:0 4px 12px rgba(124,58,237,0.15)}
.kc-id{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);margin-bottom:4px}
.kc-title{font-size:12px;font-weight:600;color:var(--text);line-height:1.4;margin-bottom:8px}
.kc-meta{display:flex;align-items:center;justify-content:space-between}

/* TOAST */
.toast-wrap{position:fixed;bottom:24px;right:24px;z-index:9998;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--surface);border:1px solid var(--border2);border-radius:8px;padding:12px 16px;font-size:13px;font-weight:500;transform:translateX(120%);transition:transform 0.3s ease;box-shadow:0 8px 24px rgba(0,0,0,0.3);display:flex;align-items:center;gap:10px;min-width:280px}
.toast.show{transform:translateX(0)}
.toast.success{border-left:3px solid var(--green)}
.toast.error{border-left:3px solid var(--danger)}
.toast.info{border-left:3px solid var(--accent)}

/* EMPTY */
.empty-state{text-align:center;padding:60px 20px;color:var(--text3)}
.empty-state .es-icon{font-size:48px;margin-bottom:12px;opacity:0.4}
.empty-state h3{font-size:16px;font-weight:600;color:var(--text2);margin-bottom:6px}
.empty-state p{font-size:13px;line-height:1.6}

/* DASHBOARD */
.dash-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:20px}
.dash-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px}
.dash-card h3{font-size:13px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:16px}
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:12px}
.bar-label{color:var(--text2);width:90px;flex-shrink:0;font-weight:500}
.bar-track{flex:1;height:6px;background:var(--surface3);border-radius:3px;overflow:hidden}
.bar-fill{height:100%;border-radius:3px;transition:width 0.6s ease}
.bar-val{color:var(--text3);width:24px;text-align:right;font-family:'JetBrains Mono',monospace}
.recent-bug-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.recent-bug-item:last-child{border-bottom:none}

/* DETAIL */
.detail-field{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.detail-field:last-child{border-bottom:none}
.detail-field .df-label{color:var(--text3);font-weight:500;font-size:12px}
.detail-field .df-val{color:var(--text);font-weight:500}

@media(max-width:1024px){.sidebar{display:none}.kanban{grid-template-columns:repeat(3,minmax(180px,1fr))}}
@media(max-width:768px){.main{padding:16px}.stats-row{grid-template-columns:1fr 1fr}.slide-panel{width:100%}.form-grid{grid-template-columns:1fr}.kanban{grid-template-columns:repeat(2,minmax(160px,1fr))}}
</style>
</head>
<body>

<!-- LOCK -->
<div id="lockScreen">
  <div class="lock-box" id="lockBox">
    <div class="lock-icon-wrap">
  <img src="https://www.ynos.in/startup/hitwicket-349713" alt="Hitwicket Logo" class="hitwicket-logo">
</div>
    <div class="lock-title">Hitwicket<span style="color:var(--accent)">BugTracker</span></div>
    <div class="lock-sub">QA ¬∑  Bug Tracker</div>
    <div class="lock-input-wrap">
      <input type="password" id="pwdInput" placeholder="Enter password‚Ä¶" onkeydown="if(event.key==='Enter')unlock()">
      <button class="lock-btn" onclick="unlock()">Enter ‚Üí</button>
    </div>
    <div class="lock-error" id="lockError"></div>
    <div class="lock-attempts" id="lockAttempts"></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="topbar">
    <div class="topbar-left">
      <div class="app-logo">H<span style="color:rgba(255,255,255,0.6)">W</span></div>
      <div class="app-name">Hitwicket<span>BugTracker</span></div>
    </div>
    <div class="topbar-right">
      <div id="connBadge" class="conn-badge load">‚è≥ Connecting</div>
      <button class="btn-icon" title="Refresh" onclick="fetchBugs()">‚Üª</button>
      <button class="btn-icon" title="Add bug" onclick="openAddPanel()">Ôºã</button>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-label">Views</div>
        <div class="sidebar-item view-item active" onclick="switchView('list',this)"><span class="si-icon">‚ò∞</span> List View</div>
        <div class="sidebar-item view-item" onclick="switchView('kanban',this)"><span class="si-icon">‚¨õ</span> Kanban Board</div>
        <div class="sidebar-item view-item" onclick="switchView('dashboard',this)"><span class="si-icon">üìä</span> Dashboard</div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label">Filter by Status</div>
        <div class="sidebar-item filter-item active-filter" onclick="filterSidebar('all',this)"><span class="si-icon">üîò</span> All Issues<span class="sidebar-badge" id="badge-all">0</span></div>
        <div class="sidebar-item filter-item" onclick="filterSidebar('Open',this)"><span class="si-icon">üü£</span> Open<span class="sidebar-badge" id="badge-open">0</span></div>
        <div class="sidebar-item filter-item" onclick="filterSidebar('In Progress',this)"><span class="si-icon">üîµ</span> In Progress<span class="sidebar-badge" id="badge-inprog">0</span></div>
        <div class="sidebar-item filter-item" onclick="filterSidebar('In Review',this)"><span class="si-icon">üü°</span> In Review<span class="sidebar-badge" id="badge-review">0</span></div>
        <div class="sidebar-item filter-item" onclick="filterSidebar('Done',this)"><span class="si-icon">üü¢</span> Done<span class="sidebar-badge" id="badge-done">0</span></div>
        <div class="sidebar-item filter-item" onclick="filterSidebar('Bugged',this)"><span class="si-icon">üî¥</span> Bugged<span class="sidebar-badge red" id="badge-bugged">0</span></div>
        <div class="sidebar-item filter-item" onclick="filterSidebar('Bug verified/QA Pass',this)"><span class="si-icon">‚úÖ</span> QA Pass<span class="sidebar-badge" id="badge-qapass">0</span></div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label">Priority</div>
        <div class="sidebar-item filter-item" onclick="filterSidebar('Critical',this,'priority')"><span class="si-icon">üî¥</span> Critical<span class="sidebar-badge red" id="badge-critical">0</span></div>
        <div class="sidebar-item filter-item" onclick="filterSidebar('High',this,'priority')"><span class="si-icon">üü†</span> High</div>
        <div class="sidebar-item filter-item" onclick="filterSidebar('Medium',this,'priority')"><span class="si-icon">üü°</span> Medium</div>
        <div class="sidebar-item filter-item" onclick="filterSidebar('Low',this,'priority')"><span class="si-icon">üü¢</span> Low</div>
        <div class="sidebar-item filter-item" onclick="filterSidebar('Urgent',this,'priority')"><span class="si-icon">üö®</span> Urgent</div>
      </div>
    </div>

    <div class="main" id="mainContent">
      <!-- LIST -->
      <div id="viewList">
        <div class="page-header">
          <div class="page-title">All Issues</div>
          <div class="page-actions">
            <button class="btn btn-secondary btn-sm" onclick="exportCSV()">üì• Export CSV</button>
            <button class="btn btn-primary" onclick="openAddPanel()">Ôºã New Bug</button>
          </div>
        </div>
        <div class="stats-row" id="statsRow"></div>
        <div class="filter-bar">
          <input type="text" class="filter-input" id="searchInput" placeholder="üîç Search bugs‚Ä¶" oninput="applyFilters()">
          <select class="filter-select" id="f-status" onchange="applyFilters()"><option value="">All Status</option></select>
          <select class="filter-select" id="f-priority" onchange="applyFilters()"><option value="">All Priority</option></select>
          <select class="filter-select" id="f-assignee" onchange="applyFilters()"><option value="">All Assignees</option></select>
          <select class="filter-select" id="f-feature" onchange="applyFilters()"><option value="">All Features</option></select>
        </div>
        <div class="bug-table-wrap">
          <div class="bug-table-header">
            <h3 id="tableTitle">Issues</h3>
            <div style="font-size:12px;color:var(--text3)" id="tableMeta"></div>
          </div>
          <div class="table-scroll"><div id="tableContainer"></div></div>
          <div class="pager" id="pagerBar">
            <div class="pager-btns">
              <button class="pager-btn" onclick="firstPage()">¬´</button>
              <button class="pager-btn" onclick="prevPage()">‚Äπ</button>
              <span class="pager-info" id="pageInfo" style="padding:0 8px"></span>
              <button class="pager-btn" onclick="nextPage()">‚Ä∫</button>
              <button class="pager-btn" onclick="lastPage()">¬ª</button>
            </div>
            <select class="filter-select" id="pageSizeSelect" onchange="changePageSize()">
              <option value="15">15 / page</option><option value="25">25 / page</option><option value="50">50 / page</option>
            </select>
          </div>
        </div>
      </div>

      <!-- KANBAN -->
      <div id="viewKanban" style="display:none">
        <div class="page-header">
          <div class="page-title">Kanban Board</div>
          <div class="page-actions"><button class="btn btn-primary" onclick="openAddPanel()">Ôºã New Bug</button></div>
        </div>
        <div class="kanban" id="kanbanBoard"></div>
      </div>

      <!-- DASHBOARD -->
      <div id="viewDashboard" style="display:none">
        <div class="page-header"><div class="page-title">Dashboard</div></div>
        <div class="stats-row" id="dashStatsRow"></div>
        <div class="dash-grid">
          <div class="dash-card"><h3>By Priority</h3><div id="chartPriority"></div></div>
          <div class="dash-card"><h3>By Status</h3><div id="chartStatus"></div></div>
          <div class="dash-card"><h3>By Assignee (Dev)</h3><div id="chartAssignee"></div></div>
          <div class="dash-card"><h3>By Feature</h3><div id="chartFeature"></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SLIDE PANEL -->
<div class="overlay" id="overlay" onclick="closePanel()"></div>
<div class="slide-panel" id="slidePanel">
  <div class="sp-header">
    <div class="sp-title" id="spTitle">New Bug</div>
    <button class="btn btn-secondary btn-sm" onclick="closePanel()">‚úï Close</button>
  </div>
  <div class="sp-body" id="spBody"></div>
  <div class="sp-footer">
    <button class="btn btn-secondary" onclick="closePanel()">Cancel</button>
    <button class="btn btn-primary" id="spSaveBtn" onclick="saveBug()">üíæ Save Bug</button>
  </div>
</div>

<div class="toast-wrap" id="toastWrap"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG ‚Äî your Cloudflare Worker URL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WORKER_URL = 'https://frosty-wood-37ecbugiq-workerjs.kunal-249.workers.dev';

let _token = null, _failCount = 0;
let bugs = [], filtered = [];
let currentPage = 1, pageSize = 15;
let sortCol = null, sortDir = 1;
let editingBugIndex = null;
let sidebarFilterMode = 'status', sidebarFilterVal = 'all';
let currentView = 'list';

const AVATAR_COLORS = ['#7c3aed','#06b6d4','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899'];
function avatarColor(n){ let h=0; for(let c of (n||'')) h=(h*31+c.charCodeAt(0))%AVATAR_COLORS.length; return AVATAR_COLORS[h]; }
function initials(n){ return n?n.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2):'??'; }

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
async function unlock() {
  const pwd=document.getElementById('pwdInput').value;
  const errEl=document.getElementById('lockError');
  const attEl=document.getElementById('lockAttempts');
  if(_failCount>=5){errEl.textContent='Too many attempts. Refresh.';return;}
  try{
    const res=await fetch(`${WORKER_URL}/api/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pwd})});
    const data=await res.json();
    if(res.ok&&data.ok){
      _token=data.token;
      const lock=document.getElementById('lockScreen');
      lock.style.transition='opacity 0.4s';lock.style.opacity='0';
      setTimeout(()=>{lock.style.display='none';document.getElementById('app').style.display='flex';fetchBugs();},400);
    } else {
      _failCount++;
      errEl.textContent=data.error||'Incorrect password';
      const rem=5-_failCount;
      if(rem>0)attEl.textContent=`${rem} attempt${rem!==1?'s':''} remaining`;
      const box=document.getElementById('lockBox');
      box.classList.remove('lock-shake');void box.offsetWidth;box.classList.add('lock-shake');
      document.getElementById('pwdInput').value='';
    }
  }catch(e){errEl.textContent='Connection error ‚Äî check Worker URL';}
}

// ‚îÄ‚îÄ API ‚îÄ‚îÄ
async function sheetAPI(payload){
  const res=await fetch(`${WORKER_URL}/api/sheet`,{method:'POST',headers:{'Content-Type':'application/json','x-session-token':_token},body:JSON.stringify(payload)});
  return res.json();
}
async function aiAPI(prompt){
  const res=await fetch(`${WORKER_URL}/api/analyze`,{method:'POST',headers:{'Content-Type':'application/json','x-session-token':_token},body:JSON.stringify({prompt})});
  return res.json();
}

// ‚îÄ‚îÄ FETCH ‚îÄ‚îÄ
async function fetchBugs(){
  setConn('load','‚è≥ Loading‚Ä¶');
  try{
    const res=await sheetAPI({action:'getData'});
    if(res&&res.success){
      bugs=res.data||[];
      setConn('ok','‚úì Connected');
      updateSidebarBadges();
      populateFilterDropdowns();
      applyFilters();
    } else {
      setConn('err','‚ö† Error');
      toast('Failed: '+(res.message||'Unknown error'),'error');
    }
  }catch(e){setConn('err','‚ö† Offline');toast('Connection error: '+e.message,'error');}
}

function setConn(cls,msg){const el=document.getElementById('connBadge');el.className='conn-badge '+cls;el.textContent=msg;}

// ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ
function populateFilterDropdowns(){
  const statuses =[...new Set(bugs.map(b=>b.Status).filter(Boolean))].sort();
  const priorities=[...new Set(bugs.map(b=>b.Priority).filter(Boolean))].sort();
  const assignees=[...new Set(bugs.map(b=>b.Assignee).filter(Boolean))].sort();
  const features=[...new Set(bugs.map(b=>b.Feature).filter(Boolean))].sort();
  const sEl=document.getElementById('f-status');
  const pEl=document.getElementById('f-priority');
  const aEl=document.getElementById('f-assignee');
  const fEl=document.getElementById('f-feature');
  sEl.innerHTML='<option value="">All Status</option>'+statuses.map(s=>`<option>${s}</option>`).join('');
  pEl.innerHTML='<option value="">All Priority</option>'+priorities.map(p=>`<option>${p}</option>`).join('');
  aEl.innerHTML='<option value="">All Assignees</option>'+assignees.map(a=>`<option>${a}</option>`).join('');
  fEl.innerHTML='<option value="">All Features</option>'+features.map(f=>`<option>${f}</option>`).join('');
}

function applyFilters(){
  const search=(document.getElementById('searchInput')?.value||'').toLowerCase();
  const status=document.getElementById('f-status')?.value||'';
  const priority=document.getElementById('f-priority')?.value||'';
  const assignee=document.getElementById('f-assignee')?.value||'';
  const feature=document.getElementById('f-feature')?.value||'';

  filtered=bugs.filter(b=>{
    if(sidebarFilterMode==='status'&&sidebarFilterVal!=='all'&&b.Status!==sidebarFilterVal) return false;
    if(sidebarFilterMode==='priority'&&b.Priority!==sidebarFilterVal) return false;
    if(status&&b.Status!==status) return false;
    if(priority&&b.Priority!==priority) return false;
    if(assignee&&b.Assignee!==assignee) return false;
    if(feature&&b.Feature!==feature) return false;
    if(search){
      const hay=[b.ID,b.Title,b.Description,b.Assignee,b.Feature,b.Steps,b.Actual].join(' ').toLowerCase();
      if(!hay.includes(search)) return false;
    }
    return true;
  });

  if(sortCol){
    filtered.sort((a,b)=>{
      const va=(a[sortCol]||'').toString(),vb=(b[sortCol]||'').toString();
      return sortDir*va.localeCompare(vb,undefined,{numeric:true});
    });
  }
  currentPage=1;
  renderCurrentView();
}

function filterSidebar(val,el,mode='status'){
  sidebarFilterMode=mode; sidebarFilterVal=val;
  // Only reset filter-item active, not view-item active
  document.querySelectorAll('.filter-item').forEach(i=>i.classList.remove('active'));
  el.classList.add('active');
  // Always switch to list view when filtering so data is visible
  currentView='list';
  document.getElementById('viewList').style.display='';
  document.getElementById('viewKanban').style.display='none';
  document.getElementById('viewDashboard').style.display='none';
  // Update view-item active to show List View is active
  document.querySelectorAll('.view-item').forEach(i=>i.classList.remove('active'));
  document.querySelector('.view-item').classList.add('active');
  applyFilters();
}

function updateSidebarBadges(){
  const c=(k,v)=>bugs.filter(b=>b[k]===v).length;
  document.getElementById('badge-all').textContent=bugs.length;
  document.getElementById('badge-open').textContent=c('Status','Open');
  document.getElementById('badge-inprog').textContent=c('Status','In Progress');
  document.getElementById('badge-review').textContent=c('Status','In Review');
  document.getElementById('badge-done').textContent=c('Status','Done');
  document.getElementById('badge-bugged').textContent=c('Status','Bugged');
  document.getElementById('badge-qapass').textContent=c('Status','Bug verified/QA Pass');
  document.getElementById('badge-critical').textContent=c('Priority','Critical');
}

// ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ
function switchView(view,el){
  currentView=view;
  ['list','kanban','dashboard'].forEach(v=>{
    const el2=document.getElementById('view'+v.charAt(0).toUpperCase()+v.slice(1));
    if(el2) el2.style.display=v===view?'':'none';
  });
  // Only reset view-item active, not filter-item active
  document.querySelectorAll('.view-item').forEach(i=>i.classList.remove('active'));
  el.classList.add('active');
  renderCurrentView();
}
function renderCurrentView(){
  if(currentView==='list') renderTable();
  if(currentView==='kanban') renderKanban();
  if(currentView==='dashboard') renderDashboard();
}

// ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ
function renderTable(){
  renderStats();
  const total=filtered.length;
  const totalPages=Math.max(1,Math.ceil(total/pageSize));
  currentPage=Math.min(Math.max(1,currentPage),totalPages);
  const start=(currentPage-1)*pageSize;
  const end=Math.min(total,start+pageSize);
  const page=filtered.slice(start,end);

  document.getElementById('tableTitle').textContent=`Issues (${total})`;
  document.getElementById('tableMeta').textContent=total?`Showing ${start+1}‚Äì${end} of ${total}`:'';
  document.getElementById('pageInfo').textContent=`${currentPage} / ${totalPages}`;

  if(!page.length){
    document.getElementById('tableContainer').innerHTML=`<div class="empty-state"><div class="es-icon">ü¶ó</div><h3>No bugs found</h3><p>Try adjusting your filters or add a new bug.</p></div>`;
    return;
  }

  const cols=['ID','Title','Priority','Severity','Status','Assignee','Feature','Build'];
  let html=`<table><thead><tr>`;
  cols.forEach(c=>{
    const arrow=sortCol===c?(sortDir===1?' ‚ñ≤':' ‚ñº'):'';
    html+=`<th onclick="doSort('${c}')">${c}${arrow}</th>`;
  });
  html+=`<th>Actions</th></tr></thead><tbody>`;

  page.forEach(bug=>{
    const realIdx=bugs.indexOf(bug);
    const av=bug.Assignee?`<div class="avatar" style="background:${avatarColor(bug.Assignee)}" title="${bug.Assignee}">${initials(bug.Assignee)}</div>`:'<span style="color:var(--text3);font-size:12px">‚Äî</span>';
    html+=`<tr onclick="openDetail(${realIdx})">
      <td class="td-id">${esc(bug.ID||'‚Äî')}</td>
      <td class="td-title" style="max-width:260px" title="${esc(bug.Title||'')}">${esc(bug.Title||'‚Äî')}</td>
      <td>${priorityChip(bug.Priority)}</td>
      <td>${severityChip(bug.Severity)}</td>
      <td>${statusChip(bug.Status)}</td>
      <td><div style="display:flex;align-items:center;gap:6px">${av}<span style="font-size:12px">${esc(bug.Assignee||'‚Äî')}</span></div></td>
      <td><span style="font-size:12px;color:var(--text2)">${esc(bug.Feature||'‚Äî')}</span></td>
      <td><span style="font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace">${esc(bug.Build||'‚Äî')}</span></td>
      <td onclick="event.stopPropagation()">
        <div class="td-actions">
          <button class="btn btn-secondary btn-sm" onclick="openEdit(${realIdx})">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-sm" onclick="deleteBug(${realIdx})">üóëÔ∏è</button>
        </div>
      </td>
    </tr>`;
  });
  html+=`</tbody></table>`;
  document.getElementById('tableContainer').innerHTML=html;
}

function doSort(col){if(sortCol===col)sortDir=-sortDir;else{sortCol=col;sortDir=1;}applyFilters();}
function changePageSize(){pageSize=parseInt(document.getElementById('pageSizeSelect').value);currentPage=1;renderTable();}
function firstPage(){currentPage=1;renderTable();}
function prevPage(){if(currentPage>1){currentPage--;renderTable();}}
function nextPage(){const t=Math.ceil(filtered.length/pageSize);if(currentPage<t){currentPage++;renderTable();}}
function lastPage(){currentPage=Math.ceil(filtered.length/pageSize)||1;renderTable();}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
function renderStats(){
  const open=bugs.filter(b=>b.Status==='Open').length;
  const inprog=bugs.filter(b=>b.Status==='In Progress'||b.Status==='Bugged').length;
  const crit=bugs.filter(b=>b.Priority==='Critical'||b.Priority==='Urgent').length;
  const done=bugs.filter(b=>b.Status==='Done'||b.Status==='Bug verified/QA Pass').length;
  document.getElementById('statsRow').innerHTML=`
    <div class="stat-card stat-open"><div class="sc-num">${open}</div><div class="sc-label">Open</div><div class="sc-bar"></div></div>
    <div class="stat-card stat-prog"><div class="sc-num">${inprog}</div><div class="sc-label">Active</div><div class="sc-bar"></div></div>
    <div class="stat-card stat-crit"><div class="sc-num">${crit}</div><div class="sc-label">Critical/Urgent</div><div class="sc-bar"></div></div>
    <div class="stat-card stat-done"><div class="sc-num">${done}</div><div class="sc-label">Resolved</div><div class="sc-bar"></div></div>`;
}

// ‚îÄ‚îÄ KANBAN ‚îÄ‚îÄ
function renderKanban(){
  const cols=['Open','Bugged','In Progress','Bug verified/QA Pass','Non-Recreatable'];
  const colColors={'Open':'var(--open)','Bugged':'var(--danger)','In Progress':'var(--inprog)','Bug verified/QA Pass':'var(--done)','Non-Recreatable':'var(--warn)'};
  let html='';
  cols.forEach(status=>{
    const colBugs=bugs.filter(b=>b.Status===status);
    html+=`<div class="kanban-col">
      <div class="kanban-col-header">
        <span class="kanban-col-title" style="color:${colColors[status]||'var(--text2)'}">${status}</span>
        <span class="kanban-count">${colBugs.length}</span>
      </div><div class="kanban-cards">`;
    colBugs.forEach(bug=>{
      const realIdx=bugs.indexOf(bug);
      const av=bug.Assignee?`<div class="avatar" style="background:${avatarColor(bug.Assignee)};width:18px;height:18px;font-size:8px">${initials(bug.Assignee)}</div>`:'';
      html+=`<div class="kanban-card" onclick="openDetail(${realIdx})">
        <div class="kc-id">${esc(bug.ID||'‚Äî')}</div>
        <div class="kc-title">${esc(bug.Title||'')}</div>
        <div class="kc-meta">${priorityChip(bug.Priority)}<div style="display:flex;align-items:center;gap:4px">${av}<span style="font-size:10px;color:var(--text3)">${esc(bug.Assignee||'')}</span></div></div>
      </div>`;
    });
    if(!colBugs.length) html+=`<div style="text-align:center;padding:20px;font-size:12px;color:var(--text3)">No bugs</div>`;
    html+=`</div></div>`;
  });
  document.getElementById('kanbanBoard').innerHTML=html;
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
function renderDashboard(){
  const open=bugs.filter(b=>b.Status==='Open').length;
  const inprog=bugs.filter(b=>b.Status==='In Progress'||b.Status==='Bugged').length;
  const crit=bugs.filter(b=>b.Priority==='Critical'||b.Priority==='Urgent').length;
  const done=bugs.filter(b=>b.Status==='Done'||b.Status==='Bug verified/QA Pass').length;
  document.getElementById('dashStatsRow').innerHTML=`
    <div class="stat-card stat-open"><div class="sc-num">${open}</div><div class="sc-label">Open</div><div class="sc-bar"></div></div>
    <div class="stat-card stat-prog"><div class="sc-num">${inprog}</div><div class="sc-label">Active</div><div class="sc-bar"></div></div>
    <div class="stat-card stat-crit"><div class="sc-num">${crit}</div><div class="sc-label">Critical/Urgent</div><div class="sc-bar"></div></div>
    <div class="stat-card stat-done"><div class="sc-num">${done}</div><div class="sc-label">Resolved</div><div class="sc-bar"></div></div>`;
  barChart('chartPriority',countBy('Priority'),{'Critical':'var(--critical)','High':'var(--high)','Medium':'var(--medium)','Low':'var(--low)','Urgent':'var(--danger)'});
  barChart('chartStatus',countBy('Status'));
  barChart('chartAssignee',countBy('Assignee'));
  barChart('chartFeature',countBy('Feature'));
}

function countBy(field){
  const map={};
  bugs.forEach(b=>{const v=b[field]||'Unknown';map[v]=(map[v]||0)+1;});
  return Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,6);
}
function barChart(id,data,colorMap={}){
  const max=data.length?Math.max(...data.map(d=>d[1])):1;
  const dc=['var(--accent)','var(--cyan)','var(--green)','var(--warn)','var(--danger)','#8b5cf6'];
  document.getElementById(id).innerHTML=data.map(([label,val],i)=>`
    <div class="bar-row">
      <div class="bar-label" title="${label}">${label.length>12?label.slice(0,12)+'‚Ä¶':label}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(val/max*100).toFixed(1)}%;background:${colorMap[label]||dc[i%dc.length]}"></div></div>
      <div class="bar-val">${val}</div>
    </div>`).join('')||'<div style="color:var(--text3);font-size:12px;padding:8px 0">No data</div>';
}

// ‚îÄ‚îÄ DETAIL ‚îÄ‚îÄ
function openDetail(idx){
  const bug=bugs[idx];
  if(!bug) return;
  editingBugIndex=idx;
  document.getElementById('spTitle').textContent=bug.ID||'Bug Detail';
  document.getElementById('spSaveBtn').style.display='none';
  document.getElementById('spBody').innerHTML=`
    <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);letter-spacing:1px;margin-bottom:8px">${esc(bug.ID||'')}</div>
    <div style="font-size:18px;font-weight:700;color:var(--text);margin-bottom:12px;line-height:1.35">${esc(bug.Title||'')}</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px">
      ${priorityChip(bug.Priority)} ${severityChip(bug.Severity)} ${statusChip(bug.Status)}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px">
      <div class="detail-field"><span class="df-label">Assignee (Dev)</span><div style="display:flex;align-items:center;gap:6px">${bug.Assignee?`<div class="avatar" style="background:${avatarColor(bug.Assignee)}">${initials(bug.Assignee)}</div>`:''}<span class="df-val">${esc(bug.Assignee||'Unassigned')}</span></div></div>
      <div class="detail-field"><span class="df-label">Tester</span><span class="df-val">${esc(bug.Reporter||'‚Äî')}</span></div>
      <div class="detail-field"><span class="df-label">Feature</span><span class="df-val">${esc(bug.Feature||'‚Äî')}</span></div>
      <div class="detail-field"><span class="df-label">Build</span><span class="df-val" style="font-family:'JetBrains Mono',monospace;font-size:12px">${esc(bug.Build||'‚Äî')}</span></div>
      <div class="detail-field"><span class="df-label">Device / User ID</span><span class="df-val">${esc(bug.Device||'‚Äî')}</span></div>
    </div>
    ${sec('Issue / Description',bug.Title||bug.Description)}
    ${sec('Repo Rate / Steps',bug.Steps)}
    ${sec('Comments / Actual Result',bug.Actual)}
    ${bug.Attachment ? `<div style="margin-bottom:14px">
      <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Attachment</div>
      <div style="background:var(--bg);padding:10px 12px;border-radius:6px;border:1px solid var(--border)">
        ${bug.Attachment.startsWith('http') 
          ? `<a href="${esc(bug.Attachment)}" target="_blank" style="color:var(--accent);font-size:13px;text-decoration:none;word-break:break-all">üîó ${esc(bug.Attachment)}</a>`
          : `<span style="font-size:13px;color:var(--text2)">üìé ${esc(bug.Attachment)}</span>`}
      </div>
    </div>` : ''}
    <div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap">
      <button class="btn btn-primary btn-sm" onclick="openEdit(${idx})">‚úèÔ∏è Edit</button>
      <button class="btn btn-danger btn-sm" onclick="deleteBug(${idx});closePanel()">üóëÔ∏è Delete</button>
    </div>`;
  openPanel();
}

function sec(title,content){
  if(!content) return '';
  return `<div style="margin-bottom:14px">
    <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">${title}</div>
    <div style="font-size:13px;color:var(--text2);line-height:1.7;white-space:pre-wrap;background:var(--bg);padding:10px 12px;border-radius:6px;border:1px solid var(--border)">${esc(content)}</div>
  </div>`;
}

// ‚îÄ‚îÄ ADD / EDIT ‚îÄ‚îÄ
function openAddPanel(){
  editingBugIndex=null;
  document.getElementById('spTitle').textContent='Ôºã New Bug';
  document.getElementById('spSaveBtn').style.display='';
  rebuildForm();
  openPanel();
}

function openEdit(idx){
  // Close first to reset state, then reopen with new bug
  document.getElementById('overlay').classList.remove('open');
  document.getElementById('slidePanel').classList.remove('open');
  
  editingBugIndex=idx;
  const bug=bugs[idx];
  document.getElementById('spTitle').textContent='‚úèÔ∏è Edit '+(bug.ID||'Bug');
  document.getElementById('spSaveBtn').style.display='';
  rebuildForm(bug);
  
  // Small delay so panel resets before reopening
  setTimeout(()=>{
    document.getElementById('overlay').classList.add('open');
    document.getElementById('slidePanel').classList.add('open');
  }, 50);
}

function rebuildForm(bug){
  const statuses=[...new Set(['Open','Bugged','In Progress','In Review','Bug verified/QA Pass','Non-Recreatable','Not a bug','Closed',...bugs.map(b=>b.Status).filter(Boolean)])];

  document.getElementById('spBody').innerHTML=`
    <div id="dupBox" style="display:none;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.3);border-radius:8px;padding:12px 14px;margin-bottom:14px">
      <div style="font-size:11px;font-weight:700;color:var(--warn);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">‚ö†Ô∏è Similar bugs already reported</div>
      <div id="dupList"></div>
    </div>
    <div class="form-grid">
      <div class="form-group full">
        <label class="form-label">Issue / Title *</label>
        <textarea class="form-textarea" id="f-title" rows="2" placeholder="Describe the bug‚Ä¶" oninput="checkDuplicates(this.value)">${esc(bug?.Title||'')}</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Priority</label>
        <select class="form-select" id="f-fpriority">
          ${['Low','Medium','High','Critical','Urgent'].map(v=>`<option value="${v}"${(bug?.Priority||'Medium')===v?' selected':''}>${v}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Priority by QA (Severity)</label>
        <select class="form-select" id="f-fseverity">
          ${['Low','Medium','High','Critical','Urgent','S1 - Blocker','S2 - Critical','S3 - Major','S4 - Minor'].map(v=>`<option value="${v}"${(bug?.Severity||'')===v?' selected':''}>${v}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select class="form-select" id="f-fstatus">
          ${statuses.map(v=>`<option value="${v}"${(bug?.Status||'Open')===v?' selected':''}>${v}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Dev (Assignee)</label>
        <input class="form-input" id="f-fassignee" value="${esc(bug?.Assignee||'')}" placeholder="Developer name">
      </div>
      <div class="form-group">
        <label class="form-label">Tester (Reporter)</label>
        <input class="form-input" id="f-freporter" value="${esc(bug?.Reporter||'Kunal (QA)')}" placeholder="Tester name">
      </div>
      <div class="form-group">
        <label class="form-label">Feature Name</label>
        <input class="form-input" id="f-ffeature" value="${esc(bug?.Feature||'')}" placeholder="e.g. Match Flow">
      </div>
      <div class="form-group">
        <label class="form-label">Build Number</label>
        <input class="form-input" id="f-fbuild" value="${esc(bug?.Build||'')}" placeholder="e.g. v3.2.1">
      </div>
      <div class="form-group">
        <label class="form-label">User ID / Device</label>
        <input class="form-input" id="f-fdevice" value="${esc(bug?.Device||'')}" placeholder="e.g. Pixel 7">
      </div>
      <div class="form-group full">
        <label class="form-label">Repo Rate / Steps to Reproduce</label>
        <textarea class="form-textarea" id="f-fsteps" rows="3" placeholder="1. Open app&#10;2. Tap...">${esc(bug?.Steps||'')}</textarea>
      </div>
      <div class="form-group full">
        <label class="form-label">Comments / Actual Result</label>
        <textarea class="form-textarea" id="f-factual" rows="3" placeholder="What actually happened?">${esc(bug?.Actual||'')}</textarea>
      </div>
      <div class="form-group full">
        <label class="form-label">Attachment (filename or link)</label>
        <input class="form-input" id="f-fattachment" value="${esc(bug?.Attachment||'')}" placeholder="e.g. screenshot_001.png or https://drive.google.com/...">
        ${bug?.Attachment ? `<div style="margin-top:6px;font-size:12px;color:var(--text3)">Current: <span style="color:var(--accent)">${esc(bug.Attachment)}</span></div>` : ''}
      </div>
    </div>`;
  if(bug?.Title) checkDuplicates(bug.Title, bug.ID);
}


function openPanel(){document.getElementById('overlay').classList.add('open');document.getElementById('slidePanel').classList.add('open');}
function closePanel(){
  document.getElementById('overlay').classList.remove('open');
  document.getElementById('slidePanel').classList.remove('open');
  editingBugIndex=null;
  // Reset form so next open is always fresh
  document.getElementById('spBody').innerHTML='';
  document.getElementById('spTitle').textContent='';
  document.getElementById('spSaveBtn').style.display='';
}

// ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ
async function saveBug(){
  const title=document.getElementById('f-title')?.value?.trim();
  if(!title){toast('Issue/Title is required!','error');return;}

  const data={
    Title:      title,
    Priority:   document.getElementById('f-fpriority')?.value||'Medium',
    Severity:   document.getElementById('f-fseverity')?.value||'',
    Status:     document.getElementById('f-fstatus')?.value||'Open',
    Assignee:   document.getElementById('f-fassignee')?.value||'',
    Reporter:   document.getElementById('f-freporter')?.value||'Kunal (QA)',
    Feature:    document.getElementById('f-ffeature')?.value||'',
    Build:      document.getElementById('f-fbuild')?.value||'',
    Device:     document.getElementById('f-fdevice')?.value||'',
    Steps:      document.getElementById('f-fsteps')?.value||'',
    Actual:     document.getElementById('f-factual')?.value||'',
    Attachment: document.getElementById('f-fattachment')?.value||'',
    'AI Notes': '',
  };

  const btn=document.getElementById('spSaveBtn');
  btn.disabled=true; btn.textContent='Saving‚Ä¶';

  try{
    let res;
    if(editingBugIndex===null){
      // ADD ‚Äî no password needed
      res=await sheetAPI({action:'addBug',data});
      if(res?.success) toast('‚úÖ Bug added! ID: '+(res.id||''), 'success');
    } else {
      // EDIT ‚Äî also no password needed
      const rowIndex=bugs[editingBugIndex]._rowIndex??editingBugIndex;
      res=await sheetAPI({action:'updateBug',index:rowIndex,data});
      if(res?.success) toast('‚úÖ Bug updated!','success');
    }
    if(!res?.success) throw new Error(res?.message||'Save failed');
    closePanel();
    await fetchBugs();
  }catch(e){
    toast('‚ùå '+e.message,'error');
  }finally{
    btn.disabled=false; btn.textContent='üíæ Save Bug';
  }
}

// ‚îÄ‚îÄ DELETE (password protected) ‚îÄ‚îÄ
const DELETE_PASSWORD = 'qa2024'; // change this to your team password

function deleteBug(idx){
  const bug=bugs[idx];
  // Show password modal
  showDeleteModal(bug, idx);
}

function showDeleteModal(bug, idx){
  // Create modal overlay
  const modal = document.createElement('div');
  modal.id = 'deleteModal';
  modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9990;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)';
  modal.innerHTML=`
    <div style="background:var(--surface);border:1px solid var(--border2);border-radius:12px;padding:32px;width:100%;max-width:400px;box-shadow:0 0 60px rgba(239,68,68,0.15)">
      <div style="font-size:20px;margin-bottom:8px">üîê Delete Restricted</div>
      <div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px;line-height:1.4">${esc(bug.Title||'')}</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:20px">Only Dev / QA Lead can delete bugs.</div>
      <label style="font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:6px">Enter Delete Password</label>
      <input type="password" id="delPwd" placeholder="Password‚Ä¶"
        style="width:100%;background:var(--bg);border:1px solid var(--border2);color:var(--text);font-size:14px;padding:10px 12px;border-radius:6px;outline:none;margin-bottom:8px;font-family:'JetBrains Mono',monospace;letter-spacing:2px"
        onkeydown="if(event.key==='Enter')confirmDelete(${idx})">
      <div id="delErr" style="font-size:12px;color:var(--danger);min-height:16px;margin-bottom:14px;font-family:'JetBrains Mono',monospace"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-secondary btn-sm" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDelete(${idx})">üóëÔ∏è Delete Bug</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  setTimeout(()=>document.getElementById('delPwd')?.focus(),50);
}

function closeDeleteModal(){
  const m=document.getElementById('deleteModal');
  if(m) m.remove();
}

async function confirmDelete(idx){
  const pwd=document.getElementById('delPwd')?.value||'';
  const errEl=document.getElementById('delErr');
  if(pwd!==DELETE_PASSWORD){
    errEl.textContent='‚ùå Wrong password!';
    document.getElementById('delPwd').value='';
    document.getElementById('delPwd').focus();
    return;
  }
  errEl.textContent='';
  closeDeleteModal();
  const bug=bugs[idx];
  const rowIndex=bug._rowIndex??idx;
  try{
    const res=await sheetAPI({action:'deleteBug',index:rowIndex});
    if(res?.success){toast('üóëÔ∏è Bug deleted','info');await fetchBugs();}
    else throw new Error(res?.message||'Delete failed');
  }catch(e){toast('‚ùå '+e.message,'error');}
}

// ‚îÄ‚îÄ DUPLICATE DETECTOR ‚îÄ‚îÄ
function checkDuplicates(inputText, currentId){
  const dupBox = document.getElementById('dupBox');
  const dupList = document.getElementById('dupList');
  if(!dupBox || !dupList) return;
  if(!inputText || inputText.trim().length < 6){ dupBox.style.display='none'; return; }

  const words = inputText.toLowerCase().trim().split(/\s+/).filter(w => w.length > 3);
  if(words.length === 0){ dupBox.style.display='none'; return; }

  // Score each bug by how many words match
  const matches = bugs
    .filter(b => b.ID !== currentId)
    .map(b => {
      const haystack = (b.Title + ' ' + b.Description + ' ' + b.Actual).toLowerCase();
      const score = words.filter(w => haystack.includes(w)).length;
      return { bug: b, score };
    })
    .filter(m => m.score >= Math.min(2, words.length))
    .sort((a,b) => b.score - a.score)
    .slice(0, 4);

  if(matches.length === 0){ dupBox.style.display='none'; return; }

  dupBox.style.display='block';
  dupList.innerHTML = matches.map(m => {
    const b = m.bug;
    const matchPct = Math.round((m.score / words.length) * 100);
    return `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(245,158,11,0.15);cursor:pointer" onclick="openDetail(${bugs.indexOf(b)});closePanel()">
      <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);flex-shrink:0">${esc(b.ID||'‚Äî')}</span>
      <span style="font-size:12px;font-weight:500;color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(b.Title||'')}</span>
      <span style="flex-shrink:0">${statusChip(b.Status)}</span>
      <span style="font-size:10px;color:var(--warn);font-weight:700;flex-shrink:0">${matchPct}%</span>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportCSV(){
  if(!filtered.length){toast('No data to export','error');return;}
  const keys=['ID','Title','Priority','Severity','Status','Assignee','Reporter','Feature','Build','Device','Steps','Actual'];
  const csv=[keys.join(',')].concat(filtered.map(b=>keys.map(k=>`"${String(b[k]||'').replace(/"/g,'""')}"`).join(','))).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`bugiq_export_${new Date().toISOString().split('T')[0]}.csv`;
  a.style.display='none';document.body.appendChild(a);a.click();a.remove();
  URL.revokeObjectURL(a.href);
  toast(`üì• Exported ${filtered.length} bugs`,'success');
}

// ‚îÄ‚îÄ CHIPS ‚îÄ‚îÄ
function priorityChip(p){
  const map={Critical:'chip-critical',High:'chip-high',Medium:'chip-medium',Low:'chip-low',Urgent:'chip-urgent'};
  const dots={Critical:'üî¥',High:'üü†',Medium:'üü°',Low:'üü¢',Urgent:'üö®'};
  return `<span class="chip ${map[p]||'chip-default'}">${dots[p]||'‚ö™'} ${p||'‚Äî'}</span>`;
}
function severityChip(s){
  const map={Critical:'chip-critical',High:'chip-high',Medium:'chip-medium',Low:'chip-low','S1 - Blocker':'chip-critical','S2 - Critical':'chip-high','S3 - Major':'chip-medium','S4 - Minor':'chip-low',Urgent:'chip-urgent'};
  return s?`<span class="chip ${map[s]||'chip-default'}">${s}</span>`:'';
}
function statusChip(s){
  const map={Open:'chip-open','In Progress':'chip-inprogress','In Review':'chip-review',Done:'chip-done',Closed:'chip-closed',Bugged:'chip-critical','Bug verified/QA Pass':'chip-done','Non-Recreatable':'chip-review','Not a bug':'chip-closed'};
  return `<span class="chip ${map[s]||'chip-default'}">${s||'‚Äî'}</span>`;
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function toast(msg,type='info'){
  const wrap=document.getElementById('toastWrap');
  const t=document.createElement('div');
  t.className=`toast ${type}`;t.textContent=msg;wrap.appendChild(t);
  requestAnimationFrame(()=>{requestAnimationFrame(()=>t.classList.add('show'));});
  setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),400);},4000);
}

// ‚îÄ‚îÄ ESC ‚îÄ‚îÄ
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
</script>
</body>
</html>
