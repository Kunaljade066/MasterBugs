<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BugTracker</title>
<style>
/* Basic reset & layout */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Roboto",sans-serif;
  background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  padding:20px; min-height:100vh; color:#1f2937; overflow-x:hidden;
}
.container{max-width:1400px;margin:0 auto}

/* Header */
.header{
  background:#fff;padding:20px;border-radius:12px;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 6px 18px rgba(2,6,23,0.08);
}
.header h1{font-size:20px;color:#111827}
.status{padding:8px 12px;border-radius:8px;font-weight:600}
.status.loading{background:#bee3f8;color:#2c5282}
.status.connected{background:#c6f6d5;color:#22543d}
.status.error{background:#fed7d7;color:#9b2c2c}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:14px}
.stat-card{background:#fff;padding:14px;border-radius:10px;text-align:center;box-shadow:0 4px 12px rgba(2,6,23,0.06)}
.stat-card h3{font-size:11px;color:#6b7280;text-transform:uppercase;margin-bottom:6px}
.stat-card .num{font-size:20px;color:#374151;font-weight:700}

/* Filters */
.filter-row{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;align-items:center}
.filter-row input[type="text"], .filter-row select, .filter-row input[type="date"]{
  padding:8px 10px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;min-width:150px;
}
.select-multi{height:40px;padding:8px 10px}

/* Table wrapper */
.table-wrapper{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
.table-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #eef2f7}
.table-header h2{font-size:16px;color:#111827}
.add-btn{background:#10b981;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}

/* Table */
.table-scroll{overflow:auto;max-height:540px}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{position:sticky;top:0;background:#f8fafc;padding:10px 12px;text-align:left;border-bottom:1px solid #e6eef7;font-weight:700;color:#374151}
tbody td{padding:10px 12px;border-bottom:1px solid #eef2f7;color:#111827;vertical-align:middle}
tbody tr:hover{background:#fbfdff}

/* Actions */
.action-buttons{display:flex;gap:8px}
.edit-btn,.delete-btn,.small-btn{padding:6px 8px;border-radius:6px;border:none;cursor:pointer;font-weight:600}
.edit-btn{background:#eef2ff;color:#2563eb}
.delete-btn{background:#fee2e2;color:#b91c1c}
.small-btn{background:#f3f4f6;color:#374151}

/* Badges */
.badge{display:inline-block;padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
.badge.priority-high{background:#fee2e2;color:#9b1c1c}
.badge.priority-medium{background:#fff7ed;color:#92400e}
.badge.priority-low{background:#ecfdf5;color:#064e3b}
/* status colors */
.status-chip{padding:6px 9px;border-radius:999px;font-weight:700;font-size:12px}
.status-chip.done{background:#d1fae5;color:#065f46}
.status-chip.inprogress{background:#e0f2fe;color:#0369a1}
.status-chip.blocker{background:#fee2e2;color:#9b1c1c}
.status-chip.onhold{background:#fff7ed;color:#92400e}

/* Pagination */
.pager{display:flex;gap:8px;align-items:center;padding:10px 12px;justify-content:space-between}
.pager .left{display:flex;gap:8px;align-items:center}

/* CSV download */
.export-btn{background:#4338ca;color:#fff;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}

/* Modal â€” add/edit */
.modal{
  position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1200;display:none;justify-content:center;align-items:flex-start;overflow-y:auto;padding:40px 20px;
}
.modal.active{display:flex}
.modal-content{background:#fff;padding:18px;border-radius:12px;width:100%;max-width:820px;max-height:92vh;overflow:auto}
.form-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
.form-group{flex:1;min-width:180px}
.form-group label{display:block;font-size:12px;color:#374151;margin-bottom:6px}
.form-group input[type="text"],.form-group textarea,.form-group select,.form-group input[type="date"]{
  width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef7;background:#fff
}
.form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.save-btn{background:#4338ca;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.cancel-btn{background:#f3f4f6;color:#111;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}

/* Preview modal for attachments */
.preview-img{max-width:90vw;max-height:80vh;border-radius:8px}

/* Sidebar comments */
.side-panel{
  position:fixed;right:0;top:0;height:100%;width:420px;background:#fff;box-shadow:-8px 0 40px rgba(2,6,23,0.12);z-index:1300;transform:translateX(100%);transition:transform .22s ease;
  display:flex;flex-direction:column;overflow:auto;
}
.side-panel.open{transform:translateX(0)}
.side-panel .panel-header{padding:16px;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center}
.side-panel .panel-body{padding:16px;flex:1;overflow:auto}
.side-panel textarea{width:100%;min-height:120px;border:1px solid #e6eef7;border-radius:8px;padding:8px}

/* small helpers */
.link-open{color:#4338ca;text-decoration:underline}
.col-sort{cursor:pointer;display:inline-flex;align-items:center;gap:6px}
.small-muted{font-size:12px;color:#6b7280}
@media(max-width:900px){
  .side-panel{width:100%}
}
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <h1>ðŸ“‹ QA Tool- BugTracker </h1>
    <div id="status" class="status loading">Connectingâ€¦</div>
  </div>

  <div id="mainArea">
    <div class="stats" id="stats"></div>

    <div class="filter-row" id="filterRow">
      <input type="text" id="searchInput" placeholder="Search all columnsâ€¦" oninput="applyFilters()">

      <!-- multi-select for Status -->
      <select id="statusFilter" multiple class="select-multi" onchange="applyFilters()" title="Status â€” multi-select">
        <!-- options populated dynamically -->
      </select>

      <!-- Owner multi-select -->
      <select id="ownerFilter" multiple class="select-multi" onchange="applyFilters()" title="Owner â€” multi-select"></select>

      <!-- Priority single-select (or multi) -->
      <select id="priorityFilter" onchange="applyFilters()">
        <option value="">All Priority</option>
      </select>

      <!-- Severity -->
      <select id="severityFilter" onchange="applyFilters()">
        <option value="">All Severity</option>
      </select>

      <!-- Date filters -->
      <label class="small-muted" style="display:inline-block;padding-top:6px">Created:</label>
      <input type="date" id="createdFrom" onchange="applyFilters()">
      <input type="date" id="createdTo" onchange="applyFilters()">

      <label class="small-muted" style="display:inline-block;padding-top:6px">Updated:</label>
      <input type="date" id="updatedFrom" onchange="applyFilters()">
      <input type="date" id="updatedTo" onchange="applyFilters()">
    </div>

    <div class="table-wrapper">
      <div class="table-header">
        <h2>Features & Issues</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="pageSize" onchange="changePageSize()" style="padding:8px;border-radius:8px;border:1px solid #e6eef7">
            <option value="10">10 / page</option>
            <option value="20">20 / page</option>
            <option value="50">50 / page</option>
          </select>
          <button class="export-btn" onclick="exportCSV()">Export CSV</button>
          <button class="add-btn" onclick="openAddModal()">+ Add New</button>
        </div>
      </div>

      <div class="table-scroll" id="tableScroll">
        <div id="tableContainer"></div>
      </div>

      <div class="pager">
        <div class="left">
          <button class="small-btn" onclick="firstPage()">Â« First</button>
          <button class="small-btn" onclick="prevPage()">â€¹ Prev</button>
          <span id="pageInfo" style="padding:0 8px"></span>
          <button class="small-btn" onclick="nextPage()">Next â€º</button>
          <button class="small-btn" onclick="lastPage()">Last Â»</button>
        </div>
        <div>
          <span class="small-muted">Showing</span>
          <strong id="showingCount"></strong>
        </div>
      </div>
    </div>

  </div>

  <div class="empty-state" id="emptyState" style="display:none;margin-top:14px">
    <h3>No data found</h3>
    <p class="small-muted">Check your sheet or deployment URL.</p>
  </div>

</div>

<!-- Add/Edit modal -->
<div class="modal" id="modal">
  <div class="modal-content" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Add / Edit</h3>
    <form id="modalForm" onsubmit="handleSave(event)">
      <div id="modalFields"></div>
      <div class="form-actions">
        <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
        <button type="submit" class="save-btn">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Attachment preview modal -->
<div class="modal" id="previewModal" onclick="closePreview(event)">
  <div class="modal-content" id="previewContent" style="max-width:900px;display:flex;flex-direction:column;align-items:center;">
    <img id="previewImage" class="preview-img" src="" alt="Preview" style="display:none">
    <a id="previewLink" class="link-open" target="_blank" rel="noopener" style="margin-top:12px;display:none">Open attachment in new tab</a>
    <div style="margin-top:12px">
      <button class="cancel-btn" onclick="closePreview(event)">Close</button>
    </div>
  </div>
</div>

<!-- Side panel for comments/details -->
<div class="side-panel" id="sidePanel">
  <div class="panel-header">
    <strong id="panelTitle">Details</strong>
    <div>
      <button class="small-btn" onclick="closePanel()">Close</button>
    </div>
  </div>
  <div class="panel-body" id="panelBody">
    <!-- dynamic -->
  </div>
  <div style="padding:12px;border-top:1px solid #eef2f7">
    <label class="small-muted">Comments</label>
    <textarea id="panelComments" placeholder="Add notes or comments..."></textarea>
    <div style="margin-top:10px;text-align:right">
      <button class="save-btn" onclick="savePanelComments()">Save Comment</button>
    </div>
  </div>
</div>

<script>
/* ============================
  Configuration
   ============================ */
let scriptUrl = "https://script.google.com/macros/s/AKfycbxCb1PHAAxeqZUJ15_QLywJGwdEMXbz1QgNMVoGEJUvYu0zjwSpU31jTLsyBJiybhcuTA/exec";
// Column names expected (adjust if your sheet uses different names)
const DATE_COLUMNS = ["Created Date","Updated Date"];
const ATTACHMENT_CANDIDATE_KEYS = []; // we'll detect any http links dynamically
// State
let rawData = [];       // original data from sheet (array of objects)
let columns = [];       // ordered column keys
let filteredData = [];  // after filters/search
let currentPage = 1;
let pageSize = 10;
let sortCol = null;
let sortDir = 1; // 1 asc, -1 desc
let activeRowIndex = null; // for panel comments (index in rawData)

/* ============================
  Utility helpers
   ============================ */
function updateStatus(msg,cls){
  const s = document.getElementById('status');
  s.textContent = msg;
  s.className = `status ${cls}`;
}
function qs(id){return document.getElementById(id);}
function isUrl(val){ return typeof val==='string' && (val.startsWith('http://')||val.startsWith('https://')); }
function safeVal(v){ return (v===null||v===undefined)?'':v; }
function parseDateFromCell(v){
  if(!v) return null;
  // Accept if already ISO or dd-mm or Excel numeric? Try Date.parse
  let d = new Date(v);
  if (!isNaN(d)) return d;
  // Try dd/mm/yyyy or dd-mm-yyyy
  const re = /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/;
  const m = (''+v).match(re);
  if(m){
    let dd=parseInt(m[1],10), mm=parseInt(m[2],10)-1, yy=parseInt(m[3],10);
    if(yy<100) yy+=2000;
    return new Date(yy,mm,dd);
  }
  return null;
}
function formatShortDate(d){
  if(!d) return '';
  const dt = new Date(d);
  return dt.toLocaleDateString();
}

/* ============================
  FETCH & INIT
   ============================ */
window.onload = function(){
  updateStatus('Connectingâ€¦','loading');
  fetchData();
  pageSize = parseInt(qs('pageSize').value,10);
};

function fetchData(){
  fetch(`${scriptUrl}?action=getData`)
    .then(r => r.text())
    .then(t => {
      let res = JSON.parse(t);
      if(res && res.success){
        rawData = res.data || [];
        columns = rawData.length ? Object.keys(rawData[0]) : [];
        // detect attachment-like columns (where values include http)
        detectAttachmentColumns();
        populateFilters();
        applyFilters(); // sets filteredData and renders
        updateStatus('Connected âœ“','connected');
      } else {
        rawData = [];
        columns = [];
        renderEmpty();
        updateStatus('No data','error');
      }
    }).catch(e=>{
      console.error(e);
      updateStatus('Connection error','error');
      renderEmpty();
    });
}

/* detect columns which include http links */
let attachmentCols = [];
function detectAttachmentColumns(){
  attachmentCols = [];
  for(let col of columns){
    for(let r of rawData){
      const v = r[col];
      if(isUrl(v)){ attachmentCols.push(col); break; }
    }
  }
}

/* ============================
  FILTERS
   ============================ */
function populateFilters(){
  // clear
  qs('statusFilter').innerHTML='';
  qs('ownerFilter').innerHTML='';
  qs('priorityFilter').innerHTML='<option value="">All Priority</option>';
  qs('severityFilter').innerHTML='<option value="">All Severity</option>';

  // multi-select placeholder (we'll add options)
  // unique extraction
  const statusSet = new Set();
  const ownerSet = new Set();
  const prioritySet = new Set();
  const severitySet = new Set();

  for(const r of rawData){
    if(r.Status) statusSet.add(r.Status);
    if(r.Owner) ownerSet.add(r.Owner);
    if(r.Priority) prioritySet.add(r.Priority);
    if(r.Severity) severitySet.add(r.Severity);
  }
  // status options (multi)
  for(const s of [...statusSet]){
    const opt = document.createElement('option'); opt.value=s; opt.textContent=s;
    qs('statusFilter').appendChild(opt);
  }
  // owner options (multi)
  for(const o of [...ownerSet]){
    const opt = document.createElement('option'); opt.value=o; opt.textContent=o;
    qs('ownerFilter').appendChild(opt);
  }
  // priority
  for(const p of [...prioritySet]){
    const opt = document.createElement('option'); opt.value=p; opt.textContent=p;
    qs('priorityFilter').appendChild(opt);
  }
  // severity
  for(const s of [...severitySet]){
    const opt = document.createElement('option'); opt.value=s; opt.textContent=s;
    qs('severityFilter').appendChild(opt);
  }
}

/* apply all filters, search, sort => filteredData */
function applyFilters(){
  const search = (qs('searchInput').value||'').toLowerCase().trim();
  const selectedStatuses = Array.from(qs('statusFilter').selectedOptions).map(o=>o.value);
  const selectedOwners = Array.from(qs('ownerFilter').selectedOptions).map(o=>o.value);
  const priority = qs('priorityFilter').value;
  const severity = qs('severityFilter').value;
  const createdFrom = qs('createdFrom').value;
  const createdTo = qs('createdTo').value;
  const updatedFrom = qs('updatedFrom').value;
  const updatedTo = qs('updatedTo').value;

  filteredData = rawData.filter(r=>{
    // status multi
    if(selectedStatuses.length && r.Status && !selectedStatuses.includes(r.Status)) return false;
    if(selectedStatuses.length && !r.Status && selectedStatuses.length) return false;
    // owner multi
    if(selectedOwners.length && r.Owner && !selectedOwners.includes(r.Owner)) return false;
    if(selectedOwners.length && !r.Owner && selectedOwners.length) return false;
    // priority
    if(priority && r.Priority!==priority) return false;
    // severity
    if(severity && r.Severity!==severity) return false;
    // date ranges
    if(createdFrom || createdTo){
      const d = parseDateFromCell(r['Created Date']);
      if(createdFrom){
        const cf = new Date(createdFrom);
        if(!d || d < cf) return false;
      }
      if(createdTo){
        const ct = new Date(createdTo); ct.setHours(23,59,59,999);
        if(!d || d > ct) return false;
      }
    }
    if(updatedFrom || updatedTo){
      const d = parseDateFromCell(r['Updated Date']);
      if(updatedFrom){
        const uf = new Date(updatedFrom);
        if(!d || d < uf) return false;
      }
      if(updatedTo){
        const ut = new Date(updatedTo); ut.setHours(23,59,59,999);
        if(!d || d > ut) return false;
      }
    }
    // search (across all columns)
    if(search){
      const vals = Object.values(r).join(' ').toLowerCase();
      if(!vals.includes(search)) return false;
    }
    return true;
  });

  // sorting
  if(sortCol){
    filteredData.sort((a,b)=>{
      let va = safeVal(a[sortCol]), vb = safeVal(b[sortCol]);
      // try date
      const da = parseDateFromCell(va), db = parseDateFromCell(vb);
      if(da && db) return sortDir * (da - db);
      // numeric?
      if(!isNaN(Number(va)) && !isNaN(Number(vb))) return sortDir * (Number(va)-Number(vb));
      // fallback string
      return sortDir * ((''+va).localeCompare(''+vb));
    });
  }

  currentPage = 1;
  renderTablePage();
  renderStats();
}

/* ============================
  RENDER â€” table with sorting, pagination, attachments, badges
   ============================ */
function renderStats(){
  qs('stats').innerHTML = `
    <div class="stat-card"><h3>Total Records</h3><div class="num">${rawData.length}</div></div>
    <div class="stat-card"><h3>Filtered</h3><div class="num">${filteredData.length}</div></div>
    <div class="stat-card"><h3>Columns</h3><div class="num">${columns.length}</div></div>
  `;
}

function getDisplayColumns(){
  // prefer order: ID, Title, Status, Priority, Owner, Severity, Created Date, Updated Date, Attachment, Comments
  const prefer = ['ID','Title','Status','Priority','Owner','Severity','Created Date','Updated Date','Attachment','Comments'];
  const cols = [];
  for(const p of prefer) if(columns.includes(p)) cols.push(p);
  for(const c of columns) if(!cols.includes(c)) cols.push(c);
  return cols;
}

function renderTablePage(){
  if(!filteredData) filteredData = [];
  if(filteredData.length===0){
    qs('tableContainer').innerHTML = `<div style="padding:20px"><em class="small-muted">No results</em></div>`;
    qs('showingCount').textContent = '0';
    qs('pageInfo').textContent = '';
    return;
  }

  pageSize = parseInt(qs('pageSize').value,10) || 10;
  const total = filteredData.length, pages = Math.max(1,Math.ceil(total/pageSize));
  if(currentPage>pages) currentPage = pages;
  const start = (currentPage-1)*pageSize, end = Math.min(total, start+pageSize);
  const pageRows = filteredData.slice(start,end);

  const dispCols = getDisplayColumns().slice(0, 12); // limit width
  let html = '<table><thead><tr>';
  for(const c of dispCols){
    html += `<th><span class="col-sort" onclick="toggleSort('${c}')">${c} ${sortCol===c? (sortDir===1? 'â–²':'â–¼') : ''}</span></th>`;
  }
  html += '<th>Attachment</th><th>Actions</th></tr></thead><tbody>';
  pageRows.forEach((r, idx)=>{
    html += '<tr>';
    for(const c of dispCols){
      const v = safeVal(r[c]);
      html += `<td>${renderCell(c,v,r)}</td>`;
    }
    // Attachment column(s) - show first attachment col detected
    let attHtml = '';
    for(const ac of attachmentCols){
      const aval = safeVal(r[ac]);
      if(aval){
        if(isUrl(aval)){
          const ext = aval.split('.').pop().toLowerCase();
          if(['png','jpg','jpeg','gif','webp'].includes(ext)){
            attHtml += `<button class="small-btn" onclick="previewAttachment('${encodeURIComponent(aval)}');event.stopPropagation()">Preview</button> `;
          } else {
            attHtml += `<a class="link-open" href="${aval}" target="_blank" rel="noopener">Open</a> `;
          }
        }
      }
    }
    html += `<td>${attHtml||'<span class="small-muted">â€”</span>'}</td>`;
    // actions
    html += `<td>
      <div class="action-buttons">
        <button class="edit-btn" onclick="openEditModal(${start+idx});">Edit</button>
        <button class="small-btn" onclick="openPanel(${start+idx});">Details</button>
        <button class="delete-btn" onclick="deleteRow(${start+idx});">Delete</button>
      </div>
    </td>`;
    html += '</tr>';
  });
  html += '</tbody></table>';
  qs('tableContainer').innerHTML = html;

  qs('pageInfo').textContent = `Page ${currentPage} of ${pages}`;
  qs('showingCount').textContent = `${start+1}-${end} / ${total}`;
}

/* render single cell with badges and clickable links */
function renderCell(col, v, rowObject){
  if(!v) return '';
  // If it's a URL, render open link
  if(isUrl(v)) return `<a class="link-open" href="${v}" target="_blank" rel="noopener">Open</a>`;
  // Priority badges
  if(col==='Priority'){
    const val = (''+v).toLowerCase();
    if(val.includes('high')) return `<span class="badge priority-high">${v}</span>`;
    if(val.includes('medium')) return `<span class="badge priority-medium">${v}</span>`;
    return `<span class="badge priority-low">${v}</span>`;
  }
  // Status chips
  if(col==='Status'){
    const s = (''+v).toLowerCase();
    if(s.includes('done')||s.includes('closed')||s.includes('completed')) return `<span class="status-chip done">${v}</span>`;
    if(s.includes('in progress')||s.includes('inprogress')||s.includes('progress')) return `<span class="status-chip inprogress">${v}</span>`;
    if(s.includes('block')||s.includes('bug')||s.includes('critical')) return `<span class="status-chip blocker">${v}</span>`;
    if(s.includes('hold')) return `<span class="status-chip onhold">${v}</span>`;
    return `<span class="status-chip">${v}</span>`;
  }
  // Dates formatting
  if(DATE_COLUMNS.includes(col)) {
    const d = parseDateFromCell(v);
    return d? formatShortDate(d) : v;
  }
  // default -> escape-ish
  return String(v).replace(/</g,'&lt;');
}

/* ============================
  Sorting helpers
   ============================ */
function toggleSort(col){
  if(sortCol===col) sortDir = -sortDir;
  else { sortCol = col; sortDir = 1; }
  applyFilters();
}

/* ============================
  Pagination controls
   ============================ */
function changePageSize(){
  pageSize = parseInt(qs('pageSize').value,10);
  currentPage = 1;
  renderTablePage();
}
function firstPage(){ currentPage=1; renderTablePage(); }
function lastPage(){ currentPage = Math.max(1, Math.ceil(filteredData.length / pageSize)); renderTablePage(); }
function prevPage(){ if(currentPage>1) currentPage--; renderTablePage(); }
function nextPage(){ if(currentPage < Math.ceil(filteredData.length / pageSize)) currentPage++; renderTablePage(); }

/* ============================
  Export CSV
   ============================ */
function exportCSV(){
  if(!filteredData.length) return alert('No rows to export');
  const dispCols = getDisplayColumns().slice(0,12);
  const rows = [dispCols];
  for(const r of filteredData){
    rows.push(dispCols.map(c=>`"${(safeVal(r[c])+'').replace(/"/g,'""')}"`));
  }
  const csv = rows.map(r=>Array.isArray(r)? r.join(','): r).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='export.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },500);
}

/* ============================
  Attachments preview
   ============================ */
function previewAttachment(encodedUrl){
  const url = decodeURIComponent(encodedUrl);
  const img = qs('previewImage'), link = qs('previewLink'), pm = qs('previewModal');
  if(url.match(/\.(jpg|jpeg|png|gif|webp)$/i)){
    img.src = url; img.style.display='block'; link.style.display='none';
  } else {
    img.style.display='none'; link.href = url; link.style.display = 'block';
  }
  pm.classList.add('active');
  pm.style.display='flex';
}
function closePreview(e){
  if(e && e.target && e.target.id && (e.target.id==='previewModal' || e.target.id==='previewContent')) return;
  const pm = qs('previewModal'); pm.classList.remove('active'); pm.style.display='none';
  qs('previewImage').src=''; qs('previewLink').href=''; qs('previewLink').style.display='none';
}

/* ============================
  Add/Edit modal (scroll safe)
   ============================ */
function openAddModal(){
  editingIndex = null;
  qs('modalTitle').textContent = 'Add New Record';
  renderModalFields({});
  qs('modal').classList.add('active');
  qs('modal').scrollTop = 0;
}
function openEditModal(globalIndex){
  editingIndex = globalIndex;
  qs('modalTitle').textContent = 'Edit Record';
  const row = rawData[globalIndex];
  renderModalFields(row);
  qs('modal').classList.add('active');
  qs('modal').scrollTop = 0;
}
function closeModal(){ qs('modal').classList.remove('active'); }

/* render fields based on columns */
function renderModalFields(row){
  const container = qs('modalFields'); container.innerHTML='';
  for(const c of columns){
    const val = safeVal(row[c]);
    const div = document.createElement('div'); div.className='form-group';
    const label = document.createElement('label'); label.textContent = c;
    if(DATE_COLUMNS.includes(c)){
      const input = document.createElement('input'); input.type='date'; 
      const d = parseDateFromCell(val); if(d) input.valueAsDate = d;
      input.name = c; div.appendChild(label); div.appendChild(input);
    } else if(c.toLowerCase().includes('comment') || c==='Comments'){
      const ta = document.createElement('textarea'); ta.name = c; ta.value = val; ta.rows=4;
      div.appendChild(label); div.appendChild(ta);
    } else if(c.toLowerCase().includes('priority')){
      const sel = document.createElement('select'); sel.name = c;
      ['High','Medium','Low'].forEach(opt=>{
        const o = document.createElement('option'); o.value=opt; o.textContent=opt; if(val===opt) o.selected=true; sel.appendChild(o);
      });
      div.appendChild(label); div.appendChild(sel);
    } else {
      const inp = document.createElement('input'); inp.type='text'; inp.name=c; inp.value=val;
      div.appendChild(label); div.appendChild(inp);
    }
    container.appendChild(div);
  }
}

/* handle save â€” calls Apps Script addRow/updateRow */
function handleSave(e){
  e.preventDefault();
  const fd = new FormData(qs('modalForm'));
  const obj = {};
  for(const [k,v] of fd.entries()) obj[k]=v;
  if(editingIndex===null){
    // add row
    fetch(`${scriptUrl}?action=addRow&data=${encodeURIComponent(JSON.stringify(obj))}`)
      .then(r=>r.text()).then(()=>{ fetchData(); closeModal(); });
  } else {
    fetch(`${scriptUrl}?action=updateRow&index=${editingIndex}&data=${encodeURIComponent(JSON.stringify(obj))}`)
      .then(r=>r.text()).then(()=>{ fetchData(); closeModal(); });
  }
}

/* ============================
  Delete row
   ============================ */
function deleteRow(globalIndex){
  if(!confirm('Delete this record?')) return;
  fetch(`${scriptUrl}?action=deleteRow&index=${globalIndex}`)
    .then(r=>r.text()).then(()=>fetchData());
}

/* ============================
  Side panel / comments
   ============================ */
function openPanel(globalIndex){
  activeRowIndex = globalIndex;
  const row = rawData[globalIndex];
  const panel = qs('sidePanel'); panel.classList.add('open');
  // title
  qs('panelTitle').textContent = row.Title || `Row ${globalIndex+1}`;
  // body â€” show key fields
  let html = '<div style="display:flex;flex-direction:column;gap:10px">';
  for(const c of getDisplayColumns().slice(0,12)){
    html += `<div><strong style="display:block;font-size:12px;color:#374151">${c}</strong><div style="margin-top:4px">${safeVal(row[c])||'<span class="small-muted">â€”</span>'}</div></div>`;
  }
  html += '</div>';
  qs('panelBody').innerHTML = html;
  qs('panelComments').value = safeVal(row.Comments || row['Comment'] || '');
}
function closePanel(){ qs('sidePanel').classList.remove('open'); activeRowIndex = null; }
function savePanelComments(){
  if(activeRowIndex===null) return alert('No row selected');
  const val = qs('panelComments').value;
  // update locally then push to sheet via updateRow
  const payload = Object.assign({}, rawData[activeRowIndex]);
  // write to Comments field (if exists) else create Comments
  if(columns.includes('Comments')) payload['Comments'] = val;
  else payload['Comments'] = val;
  fetch(`${scriptUrl}?action=updateRow&index=${activeRowIndex}&data=${encodeURIComponent(JSON.stringify(payload))}`)
    .then(r=>r.text()).then(()=>{ fetchData(); closePanel(); });
}

/* ============================
  Helper after actions
   ============================ */
function renderEmpty(){
  qs('tableContainer').innerHTML = `<div style="padding:20px"><em class="small-muted">No data available</em></div>`;
  qs('emptyState').style.display = 'block';
  qs('mainArea').style.display = 'none';
}

/* prevent panel/modal clicks from closing unintendedly */
document.addEventListener('click',function(e){
  // close preview if click outside content (handled by closePreview via id)
  // prevent closing sidepanel by clicks inside
});

</script>
    <!-- Footer -->
<footer class="footer">
  <div class="footer-left">
    <strong>QA BugTracker- Kunal Jade</strong> â€¢ v1.0
  </div>
</footer>

</body>
</html>
