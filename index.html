<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BugTracker</title>
    <style>
        /* (All CSS from your original file, unchanged except small tweaks) */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 6px 18px rgba(2,6,23,0.08);
            --accent: #4338ca;
        }

        body.dark-mode {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-gradient-start: #1e293b;
            --bg-gradient-end: #0f172a;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --shadow: 0 6px 18px rgba(0,0,0,0.3);
        }

        body {
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Roboto",sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            padding: 20px;
            min-height: 100vh;
            color: var(--text-primary);
            transition: background 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto
        }

        .header {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
        }

            .header h1 {
                font-size: 20px;
                color: var(--text-primary)
            }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .theme-toggle {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }

        .status {
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600
        }

            .status.loading {
                background: #bee3f8;
                color: #2c5282
            }

            .status.connected {
                background: #c6f6d5;
                color: #22543d
            }

            .status.error {
                background: #fed7d7;
                color: #9b2c2c
            }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .nav-tab {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 600;
        }

            .nav-tab.active {
                background: var(--accent);
                color: white;
            }

        .view-container {
            display: none;
        }

            .view-container.active {
                display: block;
            }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 18px;
            margin-bottom: 18px;
        }

        .widget {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

            .widget h3 {
                font-size: 16px;
                color: var(--text-primary);
                margin-bottom: 16px;
            }

        .stat-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
            gap: 12px;
            margin-bottom: 14px
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 14px;
            border-radius: 10px;
            text-align: center;
            box-shadow: var(--shadow);
        }

            .stat-card h3 {
                font-size: 11px;
                color: var(--text-secondary);
                text-transform: uppercase;
                margin-bottom: 6px
            }

            .stat-card .num {
                font-size: 20px;
                color: var(--text-primary);
                font-weight: 700
            }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

            .filter-row input[type="text"], .filter-row select {
                padding: 10px 12px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                background: var(--bg-primary);
                color: var(--text-primary);
                min-width: 150px;
            }

        .filter-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .table-wrapper {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

            .table-header h2 {
                font-size: 18px;
                color: var(--text-primary)
            }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .add-btn, .export-btn, .save-btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #fff;
        }

        .add-btn {
            background: #10b981;
        }

        .export-btn, .save-btn {
            background: var(--accent);
        }

        .table-scroll {
            overflow: auto;
            max-height: 600px
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px
        }

        thead th {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            padding: 12px 14px;
            text-align: left;
            border-bottom: 2px solid var(--border-color);
            font-weight: 700;
            color: var(--text-primary);
            z-index: 10;
        }

        tbody td {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            vertical-align: middle;
        }

        tbody tr:hover {
            background: var(--bg-primary);
        }

        .action-buttons {
            display: flex;
            gap: 8px
        }

        .edit-btn, .delete-btn, .small-btn {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
        }

        .edit-btn {
            background: #eef2ff;
            color: #2563eb
        }

        .delete-btn {
            background: #fee2e2;
            color: #b91c1c
        }

        .small-btn {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .badge {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 12px
        }

            .badge.priority-high {
                background: #fee2e2;
                color: #9b1c1c
            }

            .badge.priority-medium {
                background: #fff7ed;
                color: #92400e
            }

            .badge.priority-low {
                background: #ecfdf5;
                color: #064e3b
            }

        .status-chip {
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 12px
        }

            .status-chip.done {
                background: #d1fae5;
                color: #065f46
            }

            .status-chip.inprogress {
                background: #e0f2fe;
                color: #0369a1
            }

            .status-chip.blocker {
                background: #fee2e2;
                color: #9b1c1c
            }

            .status-chip.onhold {
                background: #fff7ed;
                color: #92400e
            }

        .pager {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 16px 20px;
            justify-content: space-between;
            border-top: 1px solid var(--border-color);
        }

            .pager .left {
                display: flex;
                gap: 8px;
                align-items: center
            }

        .modal {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1200;
            display: none;
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
            padding: 40px 20px;
        }

            .modal.active {
                display: flex
            }

        .modal-content {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 12px;
            width: 100%;
            max-width: 820px;
            max-height: 92vh;
            overflow: auto;
        }

        .form-group {
            margin-bottom: 12px;
        }

            .form-group label {
                display: block;
                font-size: 13px;
                color: var(--text-secondary);
                margin-bottom: 6px;
                font-weight: 600;
            }

            .form-group input, .form-group textarea, .form-group select {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                background: var(--bg-primary);
                color: var(--text-primary);
            }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 16px
        }

        .cancel-btn {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-weight: 600;
        }

        .side-panel {
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            width: 420px;
            background: var(--bg-secondary);
            box-shadow: -8px 0 40px rgba(2,6,23,0.2);
            z-index: 1300;
            transform: translateX(100%);
            transition: transform .3s ease;
            display: flex;
            flex-direction: column;
        }

            .side-panel.open {
                transform: translateX(0)
            }

            .side-panel .panel-header {
                padding: 20px;
                border-bottom: 2px solid var(--border-color);
                display: flex;
                justify-content: space-between;
                align-items: center
            }

            .side-panel .panel-body {
                padding: 20px;
                flex: 1;
                overflow: auto
            }

            .side-panel textarea {
                width: 100%;
                min-height: 120px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 10px;
                background: var(--bg-primary);
                color: var(--text-primary);
            }

        .footer {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }

            .footer p {
                color: var(--text-secondary);
                font-size: 14px;
                margin-bottom: 8px;
            }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

            .footer-links a {
                color: var(--accent);
                text-decoration: none;
                font-weight: 600;
            }

        .link-open {
            color: var(--accent);
            text-decoration: underline
        }

        .col-sort {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .small-muted {
            font-size: 12px;
            color: var(--text-secondary)
        }

        .preview-img {
            max-width: 90vw;
            max-height: 80vh;
            border-radius: 8px
        }

        @media(max-width:900px) {
            .side-panel {
                width: 100%
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://play-lh.googleusercontent.com/2YsukE1iNrOHcJZr-i3Dp5ovujjVSe6OPUz12HwDfi9Gi1wVowVBlQmHcQOaFg8PLfU"
                 alt="HitWicket Logo"
                 class="header-logo">
            <h1>üìã QA BugTracker - By Kunal Jade</h1>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
                <div id="status" class="status loading">Connecting‚Ä¶</div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchView('dashboard', event)">üìä Dashboard</button>
            <button class="nav-tab" onclick="switchView('issues', event)">üìù Issues</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboardView" class="view-container active">
            <div class="dashboard-grid">
                <div class="widget">
                    <h3>üìä Key Metrics</h3>
                    <div class="stat-list">
                        <div class="stat-item"><span class="filter-label">Total Issues</span><span class="stat-value" id="totalIssues">0</span></div>
                        <div class="stat-item"><span class="filter-label">Open</span><span class="stat-value" id="openIssues">0</span></div>
                        <div class="stat-item"><span class="filter-label">In Progress</span><span class="stat-value" id="inProgressIssues">0</span></div>
                        <div class="stat-item"><span class="filter-label">Completed</span><span class="stat-value" id="completedIssues">0</span></div>
                        <div class="stat-item"><span class="filter-label">High Priority</span><span class="stat-value" id="highPriorityIssues">0</span></div>
                    </div>
                </div>

                <div class="widget">
                    <h3>üìà Status Distribution</h3>
                    <canvas id="statusChart" width="400" height="200"></canvas>
                </div>

                <div class="widget">
                    <h3>üéØ Priority Breakdown</h3>
                    <canvas id="priorityChart" width="400" height="200"></canvas>
                </div>

                <div class="widget">
                    <h3>üë• Owner Activity</h3>
                    <div id="ownerDistribution" class="stat-list"></div>
                </div>
            </div>
        </div>

        <!-- Issues -->
        <div id="issuesView" class="view-container">
            <div class="stats" id="stats"></div>

            <div class="filter-row">
                <input type="text" id="searchInput" placeholder="üîç Search..." oninput="applyFilters()">

                <div style="display:flex;align-items:center;gap:6px">
                    <span class="filter-label">Status:</span>
                    <select id="statusFilter" onchange="applyFilters()" multiple size="3" style="min-width:220px">
                        <!-- options populated dynamically -->
                    </select>
                </div>

                <div style="display:flex;align-items:center;gap:6px">
                    <span class="filter-label">Owner:</span>
                    <select id="ownerFilter" onchange="applyFilters()" multiple size="3" style="min-width:180px"></select>
                </div>

                <div style="display:flex;align-items:center;gap:6px">
                    <span class="filter-label">Priority:</span>
                    <select id="priorityFilter" onchange="applyFilters()" multiple size="3" style="min-width:140px"></select>
                </div>

                <div style="display:flex;align-items:center;gap:6px">
                    <span class="filter-label">Severity:</span>
                    <select id="severityFilter" onchange="applyFilters()" multiple size="3" style="min-width:140px"></select>
                </div>
            </div>

            <div class="table-wrapper">
                <div class="table-header">
                    <h2>Features & Issues</h2>
                    <div class="table-actions">
                        <select id="pageSize" onchange="changePageSize()">
                            <option value="10">10 / page</option>
                            <option value="20">20 / page</option>
                            <option value="50">50 / page</option>
                        </select>
                        <button class="export-btn" onclick="exportCSV()">üì• Export</button>
                        <button class="add-btn" onclick="openAddPanel()">+ Add</button>
                    </div>
                </div>

                <div class="table-scroll">
                    <div id="tableContainer"></div>
                </div>

                <div class="pager">
                    <div class="left">
                        <button class="small-btn" onclick="firstPage()">¬´ First</button>
                        <button class="small-btn" onclick="prevPage()">‚Äπ Prev</button>
                        <span id="pageInfo"></span>
                        <button class="small-btn" onclick="nextPage()">Next ‚Ä∫</button>
                        <button class="small-btn" onclick="lastPage()">Last ¬ª</button>
                    </div>
                    <div>
                        <span class="small-muted">Showing</span>
                        <strong id="showingCount"></strong>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>¬© 2025 BugTracker - Kunal Jade (QA)</p>
            <div class="footer-links">
                <a href="#" onclick="alert('Help coming soon!');return false">üìö Help</a>
                <a href="#" onclick="alert('Contact: Kunal@hitwicket.com');return false">üìß Contact</a>
                <a href="#" onclick="alert('Version 2.0');return false">‚ÑπÔ∏è About</a>
                <style>
                    .header {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }

                    .header-logo {
                        width: 50px;
                        height: auto;
                        border-radius: 8px;
                    }
                </style>
            </div>
        </div>
    </div>

    <!-- Side panel used as Add/Edit panel -->
    <div class="side-panel" id="sidePanel" aria-hidden="true">
        <div class="panel-header">
            <strong id="panelTitle">Details</strong>
            <div>
                <button class="small-btn" onclick="closePanel()">Close</button>
            </div>
        </div>
        <div class="panel-body" id="panelBody">
            <!-- dynamic form inserted here -->
        </div>
        <div style="padding:20px;border-top:2px solid var(--border-color);display:flex;gap:10px;justify-content:flex-end">
            <button class="cancel-btn" onclick="closePanel()">Cancel</button>
            <button class="save-btn" onclick="panelSave()">Save</button>
        </div>
    </div>

    <!-- Preview modal -->
    <div class="modal" id="previewModal" onclick="closePreview(event)">
        <div class="modal-content" style="max-width:900px">
            <img id="previewImage" class="preview-img" src="" style="display:none">
            <a id="previewLink" class="link-open" target="_blank" style="display:none">Open</a>
            <div style="margin-top:12px">
                <button class="cancel-btn" onclick="closePreview()">Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        // ======= CONFIG ‚Äî REPLACE WITH YOUR DEPLOYED APPS SCRIPT URL =======
        let scriptUrl = "https://script.google.com/macros/s/AKfycbxCb1PHAAxeqZUJ15_QLywJGwdEMXbz1QgNMVoGEJUvYu0zjwSpU31jTLsyBJiybhcuTA/exec";
        // ==================================================================

        const DATE_COLUMNS = ["Created Date", "Updated Date"];
        let rawData = [], columns = [], filteredData = [];
        let currentPage = 1, pageSize = 10, sortCol = null, sortDir = 1;
        let activeRowIndex = null, editingIndex = null, attachmentCols = [];
        let lastDeleted = null; // for undo
        let statusChart = null, priorityChart = null;

        function qs(id) { return document.getElementById(id); }
        function isUrl(v) { return typeof v === 'string' && (v.startsWith('http://') || v.startsWith('https://')); }
        function safeVal(v) { return (v === null || v === undefined) ? '' : v; }

        function updateStatus(msg, cls) {
            qs('status').textContent = msg;
            qs('status').className = `status ${cls}`;
        }

        function parseDateFromCell(v) {
            if (!v) return null;
            let d = new Date(v);
            if (!isNaN(d)) return d;
            const re = /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/;
            const m = ('' + v).match(re);
            if (m) {
                let dd = parseInt(m[1], 10), mm = parseInt(m[2], 10) - 1, yy = parseInt(m[3], 10);
                if (yy < 100) yy += 2000;
                return new Date(yy, mm, dd);
            }
            return null;
        }

        function formatShortDate(d) { if (!d) return ''; return new Date(d).toLocaleDateString(); }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }

        function switchView(view, ev) {
            if (ev && ev.target) {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                ev.target.classList.add('active');
            }
            if (view === 'dashboard') {
                qs('dashboardView').classList.add('active');
                qs('issuesView').classList.remove('active');
                renderCharts();
            } else {
                qs('dashboardView').classList.remove('active');
                qs('issuesView').classList.add('active');
            }
        }

        window.onload = function () {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') document.body.classList.add('dark-mode');
            updateStatus('Connecting‚Ä¶', 'loading');
            fetchData();
        };

        // ----------------- FETCH -----------------
        function fetchData() {
            updateStatus('Loading‚Ä¶', 'loading');
            fetch(`${scriptUrl}?action=getData`)
                .then(r => r.text())
                .then(t => {
                    let res;
                    try { res = JSON.parse(t); } catch (err) { throw new Error('Invalid JSON from script'); }
                    if (res && res.success) {
                        rawData = res.data || [];
                        columns = rawData.length ? Object.keys(rawData[0]) : [];
                        detectAttachmentColumns();
                        populateFilters();
                        applyFilters();
                        updateStatus('Connected ‚úì', 'connected');
                        renderCharts();
                    } else {
                        rawData = [];
                        columns = [];
                        updateStatus('No data', 'error');
                        renderTableEmpty();
                    }
                }).catch(e => {
                    console.error(e);
                    updateStatus('Error connecting', 'error');
                    renderTableEmpty();
                });
        }

        function detectAttachmentColumns() {
            attachmentCols = [];
            for (let col of columns) {
                for (let r of rawData) {
                    if (isUrl(r[col])) { attachmentCols.push(col); break; }
                }
            }
        }

        // ----------------- FILTERS -----------------
        function populateFilters() {
            const map = {
                statusFilter: new Set(),
                ownerFilter: new Set(),
                priorityFilter: new Set(),
                severityFilter: new Set()
            };
            rawData.forEach(r => {
                if (r.Status) map.statusFilter.add(r.Status);
                if (r.Owner) map.ownerFilter.add(r.Owner);
                if (r.Priority) map.priorityFilter.add(r.Priority);
                if (r.Severity) map.severityFilter.add(r.Severity);
            });
            Object.keys(map).forEach(id => {
                const sel = qs(id);
                sel.innerHTML = '';
                // add a friendly placeholder option (non-selectable)
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.disabled = true;
                placeholder.selected = true;
                placeholder.textContent = '‚Äî Select ‚Äî (multiselect ok)';
                sel.appendChild(placeholder);
                [...map[id]].sort().forEach(val => {
                    const o = document.createElement('option');
                    o.value = val;
                    o.textContent = val;
                    sel.appendChild(o);
                });
            });
        }

        function getMultiSelectValues(id) {
            const sel = qs(id);
            const values = [];
            for (let i = 0; i < sel.options.length; i++) {
                const o = sel.options[i];
                if (o.selected && o.value !== '') values.push(o.value);
            }
            return values;
        }

        function applyFilters() {
            const search = (qs('searchInput').value || '').toLowerCase();
            const statuses = getMultiSelectValues('statusFilter');
            const owners = getMultiSelectValues('ownerFilter');
            const priorities = getMultiSelectValues('priorityFilter');
            const severities = getMultiSelectValues('severityFilter');

            filteredData = rawData.filter(r => {
                if (statuses.length && (!r.Status || !statuses.includes(r.Status))) return false;
                if (owners.length && (!r.Owner || !owners.includes(r.Owner))) return false;
                if (priorities.length && (!r.Priority || !priorities.includes(r.Priority))) return false;
                if (severities.length && (!r.Severity || !severities.includes(r.Severity))) return false;
                if (search) {
                    const vals = Object.values(r).join(' ').toLowerCase();
                    if (!vals.includes(search)) return false;
                }
                return true;
            });

            if (sortCol) {
                filteredData.sort((a, b) => {
                    let va = safeVal(a[sortCol]), vb = safeVal(b[sortCol]);
                    const da = parseDateFromCell(va), db = parseDateFromCell(vb);
                    if (da && db) return sortDir * (da - db);
                    if (!isNaN(Number(va)) && !isNaN(Number(vb))) return sortDir * (Number(va) - Number(vb));
                    return sortDir * (('' + va).localeCompare('' + vb));
                });
            }

            currentPage = 1;
            renderTablePage();
            renderStats();
            renderCharts();
        }

        // ----------------- RENDER STATS & DASHBOARD -----------------
        function renderStats() {
            qs('stats').innerHTML = `
                    <div class="stat-card"><h3>Total</h3><div class="num">${rawData.length}</div></div>
                    <div class="stat-card"><h3>Filtered</h3><div class="num">${filteredData.length}</div></div>
                    <div class="stat-card"><h3>Columns</h3><div class="num">${columns.length}</div></div>
                `;
        }

        function renderCharts() {
            // status counts
            const statusCounts = {};
            const priorityCounts = {};
            const ownerCounts = {};
            rawData.forEach(r => {
                const st = r.Status || 'Unknown'; statusCounts[st] = (statusCounts[st] || 0) + 1;
                const pr = r.Priority || 'None'; priorityCounts[pr] = (priorityCounts[pr] || 0) + 1;
                const ow = r.Owner || 'Unassigned'; ownerCounts[ow] = (ownerCounts[ow] || 0) + 1;
            });

            const statusLabels = Object.keys(statusCounts);
            const statusVals = statusLabels.map(l => statusCounts[l]);

            const prLabels = Object.keys(priorityCounts);
            const prVals = prLabels.map(l => priorityCounts[l]);

            // update numbers in top-left metrics
            qs('totalIssues').textContent = rawData.length;
            qs('openIssues').textContent = statusCounts['Open'] || 0;
            qs('inProgressIssues').textContent = statusCounts['In Progress'] || 0;
            qs('completedIssues').textContent = statusCounts['Done'] || statusCounts['Completed'] || 0;
            qs('highPriorityIssues').textContent = priorityCounts['High'] || 0;

            // status chart
            const sc = qs('statusChart').getContext('2d');
            if (statusChart) statusChart.destroy();
            statusChart = new Chart(sc, {
                type: 'doughnut',
                data: { labels: statusLabels, datasets: [{ data: statusVals }] },
                options: { plugins: { legend: { position: 'bottom' } } }
            });

            // priority chart
            const pc = qs('priorityChart').getContext('2d');
            if (priorityChart) priorityChart.destroy();
            priorityChart = new Chart(pc, {
                type: 'doughnut',
                data: { labels: prLabels, datasets: [{ data: prVals }] },
                options: { plugins: { legend: { position: 'bottom' } } }
            });

            // owner list
            const ownerDiv = qs('ownerDistribution');
            ownerDiv.innerHTML = '';
            Object.keys(ownerCounts).sort((a, b) => ownerCounts[b] - ownerCounts[a]).slice(0, 8).forEach(o => {
                const node = document.createElement('div');
                node.className = 'stat-item';
                node.innerHTML = `<span class="filter-label">${o}</span><span class="stat-value">${ownerCounts[o]}</span>`;
                ownerDiv.appendChild(node);
            });
        }

        // ----------------- TABLE RENDER -----------------
        function renderTableEmpty() {
            qs('tableContainer').innerHTML = '<div style="padding:20px">No data available.</div>';
            qs('pageInfo').textContent = '';
            qs('showingCount').textContent = '';
        }

        function renderTablePage() {
            if (!columns.length) return renderTableEmpty();

            pageSize = parseInt(qs('pageSize').value, 10);
            const total = filteredData.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            currentPage = Math.min(Math.max(1, currentPage), totalPages);

            const start = (currentPage - 1) * pageSize;
            const end = Math.min(total, start + pageSize);

            let html = `<table><thead><tr>`;
            columns.forEach(col => {
                html += `<th><span class="col-sort" onclick="toggleSort('${col}')">${col}${sortCol === col ? (sortDir === 1 ? ' ‚ñ≤' : ' ‚ñº') : ''}</span></th>`;
            });
            html += `<th>Actions</th></tr></thead><tbody>`;

            for (let i = start; i < end; i++) {
                const row = filteredData[i];
                html += `<tr>`;
                columns.forEach(col => {
                    let cell = safeVal(row[col] || '');
                    // if link
                    if (isUrl(cell)) {
                        // show small preview icon
                        cell = `<a href="#" onclick="previewAttachment(event,'${col}', ${i})">üîó</a>`;
                    } else {
                        // short display for long text
                        const txt = ('' + cell);
                        cell = txt.length > 140 ? txt.substr(0, 140) + '‚Ä¶' : txt;
                    }
                    html += `<td title="${String(row[col] || '').replace(/"/g, '&quot;')}">${cell}</td>`;
                });

                html += `<td>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="openEditPanel(${i})">Edit</button>
                            <button class="delete-btn" onclick="deleteIssue(${i})">Delete</button>
                        </div>
                    </td>`;
                html += `</tr>`;
            }
            html += `</tbody></table>`;

            qs('tableContainer').innerHTML = html;
            qs('pageInfo').textContent = `${currentPage} / ${totalPages}`;
            qs('showingCount').textContent = `${start + 1}-${end} of ${total}`;
        }

        function toggleSort(col) {
            if (sortCol === col) { sortDir = -sortDir; } else { sortCol = col; sortDir = 1; }
            applyFilters();
        }

        function changePageSize() {
            currentPage = 1;
            renderTablePage();
        }
        function firstPage() { currentPage = 1; renderTablePage(); }
        function prevPage() { if (currentPage > 1) currentPage--; renderTablePage(); }
        function nextPage() { const tot = Math.ceil(filteredData.length / pageSize); if (currentPage < tot) currentPage++; renderTablePage(); }
        function lastPage() { currentPage = Math.ceil(filteredData.length / pageSize); renderTablePage(); }

        // ----------------- PREVIEW -----------------
        function previewAttachment(event, col, filteredIndex) {
            event.preventDefault();
            const row = filteredData[filteredIndex];
            const url = row[col];
            if (!url) return;
            if (url.match(/\.(jpeg|jpg|gif|png|webp|svg)$/i)) {
                qs('previewImage').src = url;
                qs('previewImage').style.display = 'block';
                qs('previewLink').style.display = 'none';
            } else {
                qs('previewLink').href = url;
                qs('previewLink').textContent = url;
                qs('previewLink').style.display = 'inline-block';
                qs('previewImage').style.display = 'none';
            }
            qs('previewModal').classList.add('active');
        }
        function closePreview(e) {
            if (!e || e.target === qs('previewModal')) {
                qs('previewModal').classList.remove('active');
                qs('previewImage').src = '';
                qs('previewLink').href = '';
            }
        }

        // ----------------- SIDE PANEL (ADD / EDIT) -----------------
        function openAddPanel() {
            editingIndex = null;
            qs('panelTitle').textContent = 'Add Issue';
            buildPanelForm({});
            qs('sidePanel').classList.add('open');
        }

        function openEditPanel(filteredIndex) {
            editingIndex = filteredIndex;
            const row = filteredData[filteredIndex];
            qs('panelTitle').textContent = 'Edit Issue';
            buildPanelForm(row);
            qs('sidePanel').classList.add('open');
        }

        function buildPanelForm(row) {
            // row may be undefined for new
            const body = qs('panelBody');
            body.innerHTML = '';
            columns.forEach(col => {
                const val = row ? (row[col] || '') : '';
                const group = document.createElement('div');
                group.className = 'form-group';
                const label = document.createElement('label');
                label.textContent = col;
                let input;
                if (col.toLowerCase().includes('description') || col.toLowerCase().includes('notes') || col.toLowerCase().includes('steps')) {
                    input = document.createElement('textarea');
                    input.rows = 4;
                } else {
                    input = document.createElement('input');
                }
                input.name = col;
                input.value = val;
                group.appendChild(label);
                group.appendChild(input);
                body.appendChild(group);
            });

            // comments area
            const commentGroup = document.createElement('div');
            commentGroup.className = 'form-group';
            commentGroup.innerHTML = `<label>Comments</label><textarea id="panelNewComments"></textarea>`;
            body.appendChild(commentGroup);
        }

        function closePanel() {
            qs('sidePanel').classList.remove('open');
            editingIndex = null;
        }

        function panelSave() {
            // collect values
            const inputs = qs('panelBody').querySelectorAll('input,textarea');
            const payload = {};
            inputs.forEach(inp => {
                payload[inp.name] = inp.value;
            });

            if (editingIndex === null) {
                addIssue(payload);
            } else {
                // compute real index in rawData
                const rowRef = filteredData[editingIndex];
                const realIndex = rawData.findIndex(r => r === rowRef);
                if (realIndex === -1) {
                    // fallback: try matching by unique ID column if exists
                    // otherwise assume editingIndex maps to rawData index equal to position in original load
                    alert('Unable to find original row to update ‚Äî please refresh.');
                    closePanel();
                    return;
                }
                updateIssue(realIndex, payload);
            }
            closePanel();
        }

        // ----------------- CRUD -----------------
        function addIssue(rowData) {
            updateStatus('Adding‚Ä¶', 'loading');
            const url = `${scriptUrl}?action=addRow&data=${encodeURIComponent(JSON.stringify(rowData))}`;
            fetch(url).then(r => r.text()).then(t => {
                try {
                    const res = JSON.parse(t);
                    if (res && res.success) {
                        fetchData();
                    } else {
                        throw new Error(res && res.message ? res.message : 'Error adding row');
                    }
                } catch (e) { console.error(e); updateStatus('Add failed', 'error'); }
            }).catch(e => { console.error(e); updateStatus('Add failed', 'error'); });
        }

        function updateIssue(rowIndex, rowData) {
            updateStatus('Updating‚Ä¶', 'loading');
            const url = `${scriptUrl}?action=updateRow&index=${rowIndex}&data=${encodeURIComponent(JSON.stringify(rowData))}`;
            fetch(url).then(r => r.text()).then(t => {
                try {
                    const res = JSON.parse(t);
                    if (res && res.success) {
                        fetchData();
                    } else { throw new Error(res && res.message ? res.message : 'Error updating row'); }
                } catch (e) { console.error(e); updateStatus('Update failed', 'error'); }
            }).catch(e => { console.error(e); updateStatus('Update failed', 'error'); });
        }

        function deleteIssue(filteredIndex) {
            if (!confirm('Delete this issue?')) return;
            // compute real index in rawData
            const rowRef = filteredData[filteredIndex];
            const realIndex = rawData.findIndex(r => r === rowRef);
            if (realIndex === -1) { alert('Could not find row to delete. Refresh and try again.'); return; }

            // store for undo
            lastDeleted = { row: rawData[realIndex], index: realIndex, timestamp: Date.now() };

            const url = `${scriptUrl}?action=deleteRow&index=${realIndex}`;
            updateStatus('Deleting‚Ä¶', 'loading');
            fetch(url).then(r => r.text()).then(t => {
                try {
                    const res = JSON.parse(t);
                    if (res && res.success) {
                        fetchData();
                        // show temporary undo affordance (simple alert with undo)
                        if (confirm('Deleted. Undo?')) {
                            undoDelete();
                        }
                    } else { throw new Error(res && res.message ? res.message : 'Error deleting row'); }
                } catch (e) { console.error(e); updateStatus('Delete failed', 'error'); }
            }).catch(e => { console.error(e); updateStatus('Delete failed', 'error'); });
        }

        function undoDelete() {
            if (!lastDeleted || !lastDeleted.row) { alert('Nothing to undo'); return; }
            // re-add the row (append). Note: this will add a new row at the bottom.
            addIssue(lastDeleted.row);
            lastDeleted = null;
        }

        // ----------------- EXPORT -----------------
        function exportCSV() {
            const arr = filteredData.length ? filteredData : rawData;
            if (!arr.length) { alert('No data to export'); return; }
            const hdr = columns;
            const csv = [hdr.join(',')].concat(arr.map(r => hdr.map(h => `"${String(r[h] || '').replace(/"/g, '""')}"`).join(','))).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'bugtracker_export.csv'; a.style.display = 'none';
            document.body.appendChild(a); a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        // ----------------- UTIL / DEBUG -----------------
        function testConnection() {
            fetch(`${scriptUrl}?action=getData`).then(r => r.text()).then(t => {
                try { const res = JSON.parse(t); console.log(res); alert('Check console for response'); } catch (e) { alert('Invalid response'); }
            }).catch(e => { alert('Error'); console.error(e); });
        }

    </script>
</body>
</html>
